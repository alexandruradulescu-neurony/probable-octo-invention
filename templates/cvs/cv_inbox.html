{% extends "base.html" %}
{% block title %}CV Inbox — RecruitFlow{% endblock %}
{% block page_title %}CV Inbox{% endblock %}

{% block content %}

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="unmatched-tab" data-bs-toggle="tab"
            data-bs-target="#unmatched-pane" type="button" role="tab">
      Unmatched
      {% if unmatched_items %}
        <span class="badge bg-danger rounded-pill ms-1">{{ unmatched_items|length }}</span>
      {% endif %}
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="review-tab" data-bs-toggle="tab"
            data-bs-target="#review-pane" type="button" role="tab">
      Needs Review
      {% if needs_review_items %}
        <span class="badge bg-warning text-dark rounded-pill ms-1">{{ needs_review_items|length }}</span>
      {% endif %}
    </button>
  </li>
</ul>

<div class="tab-content">

  <!-- ── Tab 1: Unmatched ──────────────────────────────────────────────────── -->
  <div class="tab-pane fade show active" id="unmatched-pane" role="tabpanel">
    <div class="card border-0 shadow-sm">
      {% if unmatched_items %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Received</th>
              <th>Channel</th>
              <th>Sender</th>
              <th>Subject / Snippet</th>
              <th>Attachment</th>
              <th>Assign to Application</th>
            </tr>
          </thead>
          <tbody>
            {% for item in unmatched_items %}
            <tr>
              <td class="text-muted small text-nowrap">{{ item.received_at|date:"M j, H:i" }}</td>
              <td>
                {% if item.channel == "email" %}
                  <span class="badge bg-primary-subtle text-primary badge-status">Email</span>
                {% else %}
                  <span class="badge bg-success-subtle text-success badge-status">WhatsApp</span>
                {% endif %}
              </td>
              <td class="small">{{ item.sender|truncatechars:35 }}</td>
              <td class="small text-muted">
                {% if item.subject %}
                  {{ item.subject|truncatechars:50 }}
                {% elif item.body_snippet %}
                  {{ item.body_snippet|truncatechars:50 }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="small">{{ item.attachment_name|default:"—" }}</td>
              <td>
                <form method="post" action="{% url 'cvs:assign_unmatched' %}"
                      class="d-flex gap-1 align-items-center">
                  {% csrf_token %}
                  <input type="hidden" name="unmatched_id" value="{{ item.pk }}">
                  <input type="number" name="application_id" placeholder="App ID"
                         class="form-control form-control-sm" style="width:90px" required>
                  <button type="submit" class="btn btn-sm btn-outline-dark text-nowrap">Assign</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="card-body text-center text-muted py-5">
        <i class="bi bi-check-circle fs-1 d-block mb-2 text-success"></i>
        No unmatched inbound items. All caught up!
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ── Tab 2: Needs Review ───────────────────────────────────────────────── -->
  <div class="tab-pane fade" id="review-pane" role="tabpanel">
    <div class="card border-0 shadow-sm">
      {% if needs_review_items %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Received</th>
              <th>Candidate</th>
              <th>Position</th>
              <th>Match Method</th>
              <th>File</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for cv in needs_review_items %}
            <tr>
              <td class="text-muted small text-nowrap">{{ cv.received_at|date:"M j, H:i" }}</td>
              <td class="fw-medium small">
                {{ cv.application.candidate.full_name }}
              </td>
              <td class="small">{{ cv.application.position.title }}</td>
              <td>
                <span class="badge bg-warning-subtle text-warning badge-status">
                  {{ cv.get_match_method_display }}
                </span>
              </td>
              <td class="small">{{ cv.file_name|truncatechars:30 }}</td>
              <td>
                <div class="d-flex gap-1 flex-wrap">
                  <!-- Confirm button -->
                  <form method="post" action="{% url 'cvs:confirm_review' %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="cv_upload_id" value="{{ cv.pk }}">
                    <button type="submit" class="btn btn-sm btn-outline-success"
                            title="Confirm this match is correct">
                      <i class="bi bi-check-lg"></i> Confirm
                    </button>
                  </form>
                  <!-- Reassign form -->
                  <form method="post" action="{% url 'cvs:reassign' %}"
                        class="d-inline-flex gap-1 align-items-center">
                    {% csrf_token %}
                    <input type="hidden" name="cv_upload_id" value="{{ cv.pk }}">
                    <input type="number" name="application_id" placeholder="App ID"
                           class="form-control form-control-sm" style="width:80px" required>
                    <button type="submit" class="btn btn-sm btn-outline-secondary text-nowrap"
                            title="Move to a different application">
                      Reassign
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="card-body text-center text-muted py-5">
        <i class="bi bi-check-circle fs-1 d-block mb-2 text-success"></i>
        No CVs pending review. All caught up!
      </div>
      {% endif %}
    </div>
  </div>

</div>

{% endblock %}
