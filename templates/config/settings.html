{% extends "base.html" %}
{% load static %}

{% block title %}Settings — RecruitFlow{% endblock %}
{% block breadcrumb %}Settings{% endblock %}

{% block content %}

{# ── Gmail OAuth redirect-URI reminder banner ───────────────────────────── #}
{% if google_configured and not cred %}
<div class="alert alert-dismissible fade show d-flex align-items-start gap-2 mb-4" role="alert"
     style="background:var(--status-review-bg);border:1px solid rgba(79,70,229,0.15);border-radius:var(--radius-md);color:var(--text-primary);">
  <svg width="15" height="15" class="flex-shrink-0 mt-1" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10"></circle>
    <line x1="12" y1="8" x2="12" y2="12"></line>
    <line x1="12" y1="16" x2="12.01" y2="16"></line>
  </svg>
  <div class="text-sm">
    <strong>Before connecting Gmail</strong> — add the following Redirect URI to your
    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer"
       style="color:var(--accent-primary);text-decoration:underline;">Google Cloud Console credentials</a>:
    <code class="code-inline ms-1">{{ redirect_uri }}</code>
  </div>
  <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row g-3">

  {# ════════════════════════════════════════════════ CARD: Gmail / Email ════ #}
  <div class="col-12 col-xl-6">
    <div class="card h-100">

      <div class="card-header">
        <div class="d-flex align-items-center gap-3">
          <div class="settings-icon-wrap settings-icon-gmail">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
          </div>
          <div>
            <div class="card-header-title">Gmail / Email</div>
            <div class="text-xs" style="color:var(--text-tertiary);font-weight:500;margin-top:2px;">Google OAuth2 · CV inbox polling</div>
          </div>
        </div>
        {% if cred %}
        <span class="settings-status-badge settings-status-ok">
          <span class="settings-status-dot settings-dot-ok"></span>Connected
        </span>
        {% else %}
        <span class="settings-status-badge settings-status-off">
          <span class="settings-status-dot settings-dot-off"></span>Not connected
        </span>
        {% endif %}
      </div>

      <div class="card-body">

        {# ── Account state ── #}
        {% if cred %}
        <div class="d-flex align-items-center justify-content-between pb-3 mb-3" style="border-bottom:1px solid var(--border-light);">
          <div>
            <div class="form-label mb-1">Connected account</div>
            <div class="fw-semibold" style="font-size:0.875rem;color:var(--text-primary);">{{ cred.email_address }}</div>
            <div class="text-xs" style="color:var(--text-muted);margin-top:3px;">Connected {{ cred.connected_at|date:"N j, Y" }}</div>
          </div>
          <form method="post" action="{% url 'config:gmail_disconnect' %}" class="m-0 ms-3 flex-shrink-0">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm"
                    style="background:var(--status-rejected-bg);color:var(--status-rejected-text);border:none;"
                    onclick="return confirm('Disconnect Gmail? This will stop all email polling.')">
              Disconnect
            </button>
          </form>
        </div>
        {% else %}
        <div class="text-center py-3 pb-3 mb-3" style="border-bottom:1px solid var(--border-light);">
          <div class="text-sm mb-3" style="color:var(--text-tertiary);">No Gmail account connected</div>
          {% if google_configured %}
          <a href="{% url 'config:gmail_authorize' %}" class="btn btn-primary btn-sm d-inline-flex align-items-center gap-2">
            <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
            Connect with Google
          </a>
          {% else %}
          <div class="text-xs" style="color:var(--text-tertiary);">
            Set <code class="code-inline">GOOGLE_CLIENT_ID</code> and
            <code class="code-inline">GOOGLE_CLIENT_SECRET</code> in your <code class="code-inline">.env</code> first.
          </div>
          {% endif %}
        </div>
        {% endif %}

        {# ── Auto-polling controls ── #}
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="form-label mb-0">Auto-Polling</span>
          <button id="poll-now-btn" title="Poll Gmail inbox now"
                  {% if not cred %}disabled{% endif %}
                  class="btn-regen">
            <svg id="poll-now-icon" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.2"
                 stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <polyline points="1 4 1 10 7 10"></polyline>
              <path d="M3.51 15a9 9 0 1 0 .49-3.54"></path>
            </svg>
            Poll now
          </button>
        </div>

        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <div class="fw-medium" style="font-size:0.875rem;color:var(--text-primary);">Poll CV inbox automatically</div>
            <div class="text-xs" style="color:var(--text-tertiary);margin-top:3px;">Checks Gmail every N minutes for CV attachments</div>
          </div>
          <form method="post" action="{% url 'config:toggle_polling' %}" class="m-0 ms-3 flex-shrink-0">
            {% csrf_token %}
            <button type="submit"
                    class="settings-toggle {% if poll_enabled %}settings-toggle-on{% endif %}"
                    title="{% if poll_enabled %}Disable{% else %}Enable{% endif %} auto-polling">
              <span class="settings-toggle-thumb"></span>
            </button>
          </form>
        </div>

        <form method="post" action="{% url 'config:update_interval' %}" class="d-flex align-items-center gap-2">
          {% csrf_token %}
          <label class="fw-medium flex-grow-1 mb-0" for="poll_minutes"
                 style="font-size:0.875rem;color:var(--text-secondary);">Polling interval</label>
          <input type="number" id="poll_minutes" name="poll_minutes" min="1" max="1440"
                 value="{{ poll_minutes }}" class="form-control form-control-sm" style="width:76px;text-align:center;">
          <span class="text-xs" style="color:var(--text-tertiary);">min</span>
          <button type="submit" class="btn btn-secondary btn-sm">Save</button>
        </form>

        <div id="gmail-last-polled" class="text-xs mt-2" style="min-height:1.2rem;color:var(--text-tertiary);"></div>

      </div>
    </div>
  </div>

  {# ════════════════════════════════════════════════ CARD: Claude (Anthropic) #}
  <div class="col-12 col-xl-6">
    <div class="card h-100">

      <div class="card-header">
        <div class="d-flex align-items-center gap-3">
          <div class="settings-icon-wrap settings-icon-claude">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path>
            </svg>
          </div>
          <div>
            <div class="card-header-title">Claude (Anthropic)</div>
            <div class="text-xs" style="color:var(--text-tertiary);font-weight:500;margin-top:2px;">LLM for evaluations and CV parsing</div>
          </div>
        </div>
        <span id="claude-badge" class="settings-status-badge {% if anthropic_key_set %}settings-status-checking{% else %}settings-status-off{% endif %}">
          <span class="settings-status-dot {% if anthropic_key_set %}settings-dot-checking{% else %}settings-dot-off{% endif %}"></span>
          <span id="claude-badge-label">{% if anthropic_key_set %}Checking…{% else %}No API key{% endif %}</span>
        </span>
      </div>

      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-6">
            <div class="form-label mb-1">Primary model</div>
            <div class="fw-medium text-truncate" style="font-size:0.875rem;color:var(--text-primary);"
                 title="{{ anthropic_model }}">{{ anthropic_model }}</div>
          </div>
          <div class="col-6">
            <div class="form-label mb-1">API key</div>
            <div class="fw-medium" style="font-size:0.875rem;">
              {% if anthropic_key_set %}
                <span style="color:var(--accent-positive);">Configured ✓</span>
              {% else %}
                <span style="color:var(--accent-negative);">Not set</span>
              {% endif %}
            </div>
          </div>
          <div class="col-6">
            <div class="form-label mb-1">Latency</div>
            <div class="fw-medium" id="claude-latency" style="font-size:0.875rem;color:var(--text-primary);">—</div>
          </div>
          <div class="col-6">
            <div class="form-label mb-1">Last check</div>
            <div class="fw-medium" id="claude-last-check" style="font-size:0.875rem;color:var(--text-primary);">—</div>
          </div>
        </div>

        <div class="text-xs" style="color:var(--text-tertiary);line-height:1.55;">
          API key is set via <code class="code-inline">ANTHROPIC_API_KEY</code> in
          <code class="code-inline">.env</code>. Restart the server after changing it.
        </div>
      </div>

    </div>
  </div>

  {# ════════════════════════════════════════════════ CARD: Whapi (WhatsApp) ══ #}
  <div class="col-12 col-xl-6">
    <div class="card h-100">

      <div class="card-header">
        <div class="d-flex align-items-center gap-3">
          <div class="settings-icon-wrap settings-icon-whapi">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
          </div>
          <div>
            <div class="card-header-title">Whapi (WhatsApp)</div>
            <div class="text-xs" style="color:var(--text-tertiary);font-weight:500;margin-top:2px;">Outbound WhatsApp messaging</div>
          </div>
        </div>
        <span id="whapi-badge" class="settings-status-badge {% if whapi_token_set %}settings-status-checking{% else %}settings-status-off{% endif %}">
          <span class="settings-status-dot {% if whapi_token_set %}settings-dot-checking{% else %}settings-dot-off{% endif %}"></span>
          <span id="whapi-badge-label">{% if whapi_token_set %}Checking…{% else %}No token{% endif %}</span>
        </span>
      </div>

      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="form-label mb-1">API endpoint</div>
            <div class="fw-medium text-truncate" style="font-size:0.875rem;color:var(--text-primary);"
                 title="{{ whapi_url }}">{{ whapi_url|default:"— not configured —" }}</div>
          </div>
          <div class="col-6">
            <div class="form-label mb-1">Token</div>
            <div class="fw-medium" style="font-size:0.875rem;">
              {% if whapi_token_set %}
                <span style="color:var(--accent-positive);">Configured ✓</span>
              {% else %}
                <span style="color:var(--accent-negative);">Not set</span>
              {% endif %}
            </div>
          </div>
          <div class="col-6">
            <div class="form-label mb-1">Latency</div>
            <div class="fw-medium" id="whapi-latency" style="font-size:0.875rem;color:var(--text-primary);">—</div>
          </div>
        </div>

        <div class="text-xs" style="color:var(--text-tertiary);line-height:1.55;">
          Set <code class="code-inline">WHAPI_TOKEN</code> and <code class="code-inline">WHAPI_API_URL</code>
          in <code class="code-inline">.env</code>. Restart the server after changing them.
        </div>
      </div>

    </div>
  </div>

  {# ════════════════════════════════════════════════ CARD: System ════════════ #}
  <div class="col-12 col-xl-6">
    <div class="card h-100">

      <div class="card-header">
        <div class="d-flex align-items-center gap-3">
          <div class="settings-icon-wrap settings-icon-system">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
              <line x1="8" y1="21" x2="16" y2="21"></line>
              <line x1="12" y1="17" x2="12" y2="21"></line>
            </svg>
          </div>
          <div>
            <div class="card-header-title">System</div>
            <div class="text-xs" style="color:var(--text-tertiary);font-weight:500;margin-top:2px;">Uptime, scheduler, background jobs</div>
          </div>
        </div>
        <span class="settings-status-badge settings-status-ok">
          <span class="settings-status-dot settings-dot-ok"></span>Running
        </span>
      </div>

      <div class="card-body">

        <div class="row g-3 pb-3 mb-3" style="border-bottom:1px solid var(--border-light);">
          <div class="col-6">
            <div class="form-label mb-1">Uptime</div>
            <div class="fw-medium" id="system-uptime" style="font-size:0.875rem;color:var(--text-primary);">Loading…</div>
          </div>
          <div class="col-6">
            <div class="form-label mb-1">Server started</div>
            <div class="fw-medium" id="system-start" style="font-size:0.875rem;color:var(--text-primary);">—</div>
          </div>
        </div>

        <div class="form-label mb-2">Scheduler Jobs</div>
        <div id="scheduler-jobs-table">
          <div class="text-sm text-center py-3" style="color:var(--text-tertiary);">Loading…</div>
        </div>

      </div>
    </div>
  </div>

</div>{# /row #}
{% endblock %}


{% block extra_js %}
<script>
(function () {
  "use strict";

  const STATUS_URL  = "{% url 'config:status_json' %}";
  const POLL_NOW_URL = "{% url 'config:gmail_poll_now' %}";
  const REFRESH_MS  = 30000;

  // ── Helpers ────────────────────────────────────────────────────────────────

  function dot(status) {
    const map = {
      ok:           "settings-dot-ok",
      error:        "settings-dot-error",
      disconnected: "settings-dot-off",
      checking:     "settings-dot-checking",
    };
    return map[status] || "settings-dot-off";
  }

  function badgeClass(status) {
    const map = {
      ok:           "settings-status-ok",
      error:        "settings-status-error",
      disconnected: "settings-status-off",
    };
    return map[status] || "settings-status-off";
  }

  function setBadge(badgeEl, labelEl, status, label) {
    badgeEl.className = "settings-status-badge " + badgeClass(status);
    const dotEl = badgeEl.querySelector(".settings-status-dot");
    if (dotEl) dotEl.className = "settings-status-dot " + dot(status);
    if (labelEl) labelEl.textContent = label;
  }

  function formatUptime(seconds) {
    if (seconds === null || seconds === undefined) return "—";
    const d = Math.floor(seconds / 86400);
    const h = Math.floor((seconds % 86400) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    const parts = [];
    if (d) parts.push(d + "d");
    if (h) parts.push(h + "h");
    if (m) parts.push(m + "m");
    parts.push(s + "s");
    return parts.join(" ");
  }

  function formatDate(iso) {
    if (!iso) return "—";
    try { return new Date(iso).toLocaleString(); } catch (_) { return iso; }
  }

  // ── Gmail ──────────────────────────────────────────────────────────────────

  function renderGmail(data) {
    const lastPolledEl = document.getElementById("gmail-last-polled");
    if (!lastPolledEl) return;
    if (data.status === "error") {
      lastPolledEl.innerHTML = '<span style="color:var(--accent-negative);">⚠ Token error — reconnect Gmail.</span>';
    }
  }

  // ── Poll-now button ────────────────────────────────────────────────────────

  (function initPollNow() {
    const btn          = document.getElementById("poll-now-btn");
    const icon         = document.getElementById("poll-now-icon");
    const lastPolledEl = document.getElementById("gmail-last-polled");
    if (!btn) return;

    btn.addEventListener("click", function () {
      btn.disabled = true;
      icon.style.animation = "rf-spin 0.8s linear infinite";
      if (lastPolledEl) {
        lastPolledEl.textContent = "Polling…";
        lastPolledEl.style.color = "var(--text-tertiary)";
      }

      const csrfToken = (document.querySelector("[name=csrfmiddlewaretoken]") || {}).value || "";

      fetch(POLL_NOW_URL, {
        method: "POST",
        credentials: "same-origin",
        headers: { "X-CSRFToken": csrfToken },
      })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          btn.disabled = false;
          icon.style.animation = "";
          if (lastPolledEl) {
            const ts = new Date().toLocaleTimeString();
            if (data.ok) {
              let detail = "";
              if (typeof data.query_matches !== "undefined") {
                const scope = data.label ? "\u201c" + data.label + "\u201d" : "inbox";
                detail = " · " + scope + " · "
                  + data.query_matches + " unread · "
                  + (data.with_cv || 0) + " w/CV · "
                  + (data.skipped || 0) + " skipped · "
                  + (data.processed || 0) + " ingested";
              }
              lastPolledEl.innerHTML =
                '<span style="color:var(--accent-positive)">✓ ' + ts + " — " + data.message + "</span>"
                + (detail ? '<br><span style="color:var(--text-muted);font-size:0.7rem;">' + detail + "</span>" : "");
            } else {
              lastPolledEl.innerHTML =
                '<span style="color:var(--accent-negative)">⚠ ' + (data.error || "Unknown error") + "</span>";
            }
          }
        })
        .catch(function () {
          btn.disabled = false;
          icon.style.animation = "";
          if (lastPolledEl) {
            lastPolledEl.innerHTML =
              '<span style="color:var(--accent-negative)">⚠ Network error — poll failed.</span>';
          }
        });
    });
  }());

  // ── Claude ─────────────────────────────────────────────────────────────────

  function renderClaude(data) {
    const badge     = document.getElementById("claude-badge");
    const label     = document.getElementById("claude-badge-label");
    const latency   = document.getElementById("claude-latency");
    const lastCheck = document.getElementById("claude-last-check");
    if (!badge) return;

    if (data.status === "ok") {
      setBadge(badge, label, "ok", "Connected");
      if (latency) latency.textContent = data.latency_ms + " ms";
    } else if (data.status === "disconnected") {
      setBadge(badge, label, "disconnected", "No API key");
    } else {
      setBadge(badge, label, "error", "Error");
      if (latency) latency.textContent = "—";
    }
    if (lastCheck) lastCheck.textContent = new Date().toLocaleTimeString();
  }

  // ── Whapi ──────────────────────────────────────────────────────────────────

  function renderWhapi(data) {
    const badge   = document.getElementById("whapi-badge");
    const label   = document.getElementById("whapi-badge-label");
    const latency = document.getElementById("whapi-latency");
    if (!badge) return;

    if (data.status === "ok") {
      setBadge(badge, label, "ok", "Connected");
      if (latency) latency.textContent = data.latency_ms + " ms";
    } else if (data.status === "disconnected") {
      setBadge(badge, label, "disconnected", "No token");
    } else {
      setBadge(badge, label, "error", "Error");
      if (latency) latency.textContent = "—";
    }
  }

  // ── System ─────────────────────────────────────────────────────────────────

  function renderSystem(data) {
    const uptimeEl  = document.getElementById("system-uptime");
    const startEl   = document.getElementById("system-start");
    const tableEl   = document.getElementById("scheduler-jobs-table");

    if (uptimeEl) uptimeEl.textContent = formatUptime(data.uptime_seconds);
    if (startEl)  startEl.textContent  = data.server_start ? formatDate(data.server_start) : "—";
    if (!tableEl) return;

    const jobs = data.jobs || [];
    if (!jobs.length) {
      tableEl.innerHTML = '<div class="text-sm text-center py-2" style="color:var(--text-tertiary);">No scheduler jobs registered.</div>';
      return;
    }

    const statusHtml = function (s) {
      if (!s) return '<span style="color:var(--text-muted);">—</span>';
      if (s === "Executed") return '<span style="color:var(--accent-positive);font-weight:600;">✓ OK</span>';
      if (s === "Error")    return '<span style="color:var(--accent-negative);font-weight:600;">✗ Error</span>';
      return '<span style="color:var(--text-tertiary);">' + s + "</span>";
    };

    let html = '<table style="width:100%;border-collapse:collapse;font-size:0.78rem;">';
    html += '<thead><tr style="border-bottom:1px solid var(--border-light);">';
    html += '<th style="padding:0 0 6px;font-weight:700;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);">Job</th>';
    html += '<th style="padding:0 0 6px;font-weight:700;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);text-align:right;">Last run</th>';
    html += '<th style="padding:0 0 6px;font-weight:700;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);text-align:right;">Next run</th>';
    html += '<th style="padding:0 0 6px;font-weight:700;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary);text-align:right;">Status</th>';
    html += "</tr></thead><tbody>";

    jobs.forEach(function (j) {
      html += '<tr style="border-bottom:1px solid var(--border-light);">';
      html += '<td style="padding:6px 0;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-secondary);font-weight:500;">' + j.id + "</td>";
      html += '<td style="padding:6px 0;text-align:right;color:var(--text-tertiary);">' + (j.last_run_time ? formatDate(j.last_run_time) : "—") + "</td>";
      html += '<td style="padding:6px 0;text-align:right;color:var(--text-tertiary);">' + (j.next_run_time ? formatDate(j.next_run_time) : "—") + "</td>";
      html += '<td style="padding:6px 0;text-align:right;">' + statusHtml(j.last_status) + "</td>";
      html += "</tr>";
    });

    html += "</tbody></table>";
    tableEl.innerHTML = html;
  }

  // ── Main refresh loop ──────────────────────────────────────────────────────

  function refresh() {
    fetch(STATUS_URL, { credentials: "same-origin" })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        renderGmail(data.gmail   || {});
        renderClaude(data.claude || {});
        renderWhapi(data.whapi   || {});
        renderSystem(data.system || {});
      })
      .catch(function (err) {
        console.warn("Settings status fetch failed:", err);
      });
  }

  refresh();
  setInterval(refresh, REFRESH_MS);
}());
</script>
{% endblock %}
