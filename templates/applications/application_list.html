{% extends "base.html" %}
{% block title %}Applications — RecruitFlow{% endblock %}
{% block page_title %}Applications{% endblock %}

{% block content %}

<!-- Filters -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body py-3">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label small mb-1">Position</label>
        <select name="position" class="form-select form-select-sm">
          <option value="">All positions</option>
          {% for pos in positions %}
          <option value="{{ pos.pk }}" {% if current_filters.position == pos.pk|stringformat:"d" %}selected{% endif %}>
            {{ pos.title }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">Status</label>
        <select name="status" class="form-select form-select-sm">
          <option value="">All statuses</option>
          {% for value, label in status_choices %}
          <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>
            {{ label }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">Qualified</label>
        <select name="qualified" class="form-select form-select-sm">
          <option value="">Any</option>
          <option value="true" {% if current_filters.qualified == "true" %}selected{% endif %}>Yes</option>
          <option value="false" {% if current_filters.qualified == "false" %}selected{% endif %}>No</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">From</label>
        <input type="date" name="date_from" value="{{ current_filters.date_from }}"
               class="form-control form-control-sm">
      </div>
      <div class="col-md-2">
        <label class="form-label small mb-1">To</label>
        <input type="date" name="date_to" value="{{ current_filters.date_to }}"
               class="form-control form-control-sm">
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-sm btn-dark w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Bulk action bar (hidden until checkboxes selected) -->
<form method="post" action="{% url 'applications:trigger_calls' %}" id="bulk-form">
  {% csrf_token %}

  <div id="bulk-bar" class="alert alert-dark d-flex align-items-center justify-content-between mb-3" style="display:none!important">
    <span><strong id="bulk-count">0</strong> application(s) selected</span>
    <button type="submit" class="btn btn-sm btn-warning">
      <i class="bi bi-telephone-outbound"></i> Trigger Calls
    </button>
  </div>

  <!-- Data table -->
  <div class="card border-0 shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:2.5rem">
              <input type="checkbox" class="form-check-input" id="select-all"
                     title="Select all pending_call applications">
            </th>
            <th>Candidate</th>
            <th>Position</th>
            <th>Status</th>
            <th class="text-center">Score</th>
            <th>Last Activity</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for app in applications %}
          <tr>
            <td>
              {% if app.status == "pending_call" %}
              <input type="checkbox" class="form-check-input row-check"
                     name="application_ids" value="{{ app.pk }}">
              {% endif %}
            </td>
            <td>
              <div class="fw-medium">{{ app.candidate.full_name }}</div>
              <div class="text-muted small">{{ app.candidate.phone }}</div>
            </td>
            <td class="small">{{ app.position.title }}</td>
            <td>{% include "applications/_status_badge.html" with status=app.status %}</td>
            <td class="text-center">
              {% if app.score is not None %}
                <span class="fw-semibold {% if app.qualified %}text-success{% else %}text-danger{% endif %}">
                  {{ app.score }}
                </span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-muted small">{{ app.updated_at|timesince }} ago</td>
            <td class="text-end">
              <a href="{% url 'applications:detail' app.pk %}"
                 class="btn btn-sm btn-outline-dark">View</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted py-4">
              No applications match the current filters.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  <!-- Pagination -->
  {% if is_paginated %}
  <div class="card-footer bg-white d-flex justify-content-center">
    <nav>
      <ul class="pagination pagination-sm mb-0">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">&laquo;</a>
        </li>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
          <li class="page-item">
            <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ num }}">{{ num }}</a>
          </li>
          {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">&raquo;</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
</form>

{% endblock %}

{% block extra_js %}
<script>
(function() {
  const selectAll = document.getElementById('select-all');
  const bulkBar = document.getElementById('bulk-bar');
  const bulkCount = document.getElementById('bulk-count');
  const checks = document.querySelectorAll('.row-check');

  function updateBar() {
    const checked = document.querySelectorAll('.row-check:checked').length;
    bulkCount.textContent = checked;
    bulkBar.style.cssText = checked > 0 ? '' : 'display:none!important';
  }

  selectAll.addEventListener('change', function() {
    checks.forEach(c => c.checked = selectAll.checked);
    updateBar();
  });

  checks.forEach(c => c.addEventListener('change', updateBar));
})();
</script>
{% endblock %}
