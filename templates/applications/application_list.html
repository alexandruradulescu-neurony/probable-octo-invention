{% extends "base.html" %}
{% block title %}Applications — RecruitFlow{% endblock %}
{% block breadcrumb %}Applications{% endblock %}
{% block page_title %}Applications{% endblock %}

{% block extra_css %}
<style>
  .period-tabs { display:flex; background:var(--bg-page); border:1px solid var(--border-default); border-radius:8px; padding:3px; gap:2px; }
  .period-tab  { padding:4px 14px; border-radius:5px; font-size:0.78rem; font-weight:600; color:var(--text-tertiary); text-decoration:none; transition:all 0.15s; white-space:nowrap; }
  .period-tab:hover { color:var(--text-primary); }
  .period-tab.active { background:#fff; color:var(--text-primary); box-shadow:0 1px 3px rgba(15,23,42,0.10); }
  .ov-metrics { display:flex; border-bottom:1px solid var(--border-light); margin-bottom:1.5rem; padding-bottom:1.25rem; }
  .ov-metric  { flex:1; padding:0 1.5rem; border-right:1px solid var(--border-light); }
  .ov-metric:first-child { padding-left:0; }
  .ov-metric:last-child  { border-right:none; }
  .ov-metric-label { display:flex; align-items:center; gap:6px; font-size:0.70rem; font-weight:700; color:var(--text-tertiary); text-transform:uppercase; letter-spacing:0.07em; margin-bottom:0.5rem; }
  .ov-metric-dot   { width:7px; height:7px; border-radius:50%; flex-shrink:0; }
  .ov-metric-value { font-size:2rem; font-weight:800; color:var(--text-primary); line-height:1; letter-spacing:-0.04em; margin-bottom:0.4rem; font-variant-numeric:tabular-nums; }
  .ov-metric-sub   { font-size:0.78rem; color:var(--text-muted); font-weight:500; }
  .trend-badge { display:inline-flex; align-items:center; gap:2px; font-size:0.72rem; font-weight:700; padding:2px 8px; border-radius:99px; }
  .trend-up   { background:rgba(16,185,129,0.10); color:#059669; }
  .trend-down { background:rgba(239,68,68,0.10);  color:#DC2626; }
</style>
{% endblock %}

{% block content %}
{# ── Activity Overview ───────────────────────────────────────────── #}
<div class="card mb-4">
  <div class="card-header">
    <h2 class="card-header-title">Open Positions Overview</h2>
    <div class="period-tabs">
      <a href="{{ period_urls.7 }}"  class="period-tab {% if period == 7  %}active{% endif %}">7 days</a>
      <a href="{{ period_urls.14 }}" class="period-tab {% if period == 14 %}active{% endif %}">14 days</a>
      <a href="{{ period_urls.30 }}" class="period-tab {% if period == 30 %}active{% endif %}">30 days</a>
    </div>
  </div>
  <div class="card-body" style="padding:1.5rem 1.5rem 1.25rem;">

    <div class="ov-metrics">

      <div class="ov-metric">
        <div class="ov-metric-label"><div class="ov-metric-dot" style="background:#4F46E5;"></div>Calls</div>
        <div class="ov-metric-value">{{ kpi_totals.calls }}</div>
        {% if kpi_totals.calls_trend %}
        <span class="trend-badge {% if kpi_totals.calls_trend.up %}trend-up{% else %}trend-down{% endif %}">
          {% if kpi_totals.calls_trend.up %}↑{% else %}↓{% endif %} {{ kpi_totals.calls_trend.pct }}%
        </span>
        {% else %}<span class="ov-metric-sub">No prior data</span>{% endif %}
      </div>

      <div class="ov-metric">
        <div class="ov-metric-label"><div class="ov-metric-dot" style="background:#10B981;"></div>CVs Received</div>
        <div class="ov-metric-value">{{ kpi_totals.cvs }}</div>
        {% if kpi_totals.cvs_trend %}
        <span class="trend-badge {% if kpi_totals.cvs_trend.up %}trend-up{% else %}trend-down{% endif %}">
          {% if kpi_totals.cvs_trend.up %}↑{% else %}↓{% endif %} {{ kpi_totals.cvs_trend.pct }}%
        </span>
        {% else %}<span class="ov-metric-sub">No prior data</span>{% endif %}
      </div>

      <div class="ov-metric">
        <div class="ov-metric-label"><div class="ov-metric-dot" style="background:#8B5CF6;"></div>Follow-ups</div>
        <div class="ov-metric-value">{{ kpi_totals.followups }}</div>
        {% if kpi_totals.followups_trend %}
        <span class="trend-badge {% if kpi_totals.followups_trend.up %}trend-up{% else %}trend-down{% endif %}">
          {% if kpi_totals.followups_trend.up %}↑{% else %}↓{% endif %} {{ kpi_totals.followups_trend.pct }}%
        </span>
        {% else %}<span class="ov-metric-sub">No prior data</span>{% endif %}
      </div>

      <div class="ov-metric">
        <div class="ov-metric-label">Open Positions</div>
        <div class="ov-metric-value">{{ open_positions_count }}</div>
        <span class="ov-metric-sub">Currently active</span>
      </div>

    </div>

    {{ positions_chart_data|json_script:"applist-chart-data" }}
    <div style="position:relative;height:220px;">
      <canvas id="applist-activity-chart"></canvas>
    </div>

  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Position</label>
        <select name="position" class="form-select">
          <option value="">All positions</option>
          {% for pos in positions %}
          <option value="{{ pos.pk }}" {% if current_filters.position == pos.pk|stringformat:"d" %}selected{% endif %}>{{ pos.title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="">All statuses</option>
          {% for value, label in status_choices %}
          <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Qualified</label>
        <select name="qualified" class="form-select">
          <option value="">Any</option>
          <option value="true" {% if current_filters.qualified == "true" %}selected{% endif %}>Yes</option>
          <option value="false" {% if current_filters.qualified == "false" %}selected{% endif %}>No</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">From</label>
        <input type="date" name="date_from" value="{{ current_filters.date_from }}" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">To</label>
        <input type="date" name="date_to" value="{{ current_filters.date_to }}" class="form-control">
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<form method="post" action="{% url 'applications:bulk_action' %}" id="bulk-form">
  {% csrf_token %}
  <input type="hidden" name="confirm_delete" value="yes">

  <div id="bulk-bar" class="bulk-action-bar mb-3" style="display:none;">
    <span class="bulk-count-label"><strong id="bulk-count">0</strong> selected</span>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="bulk-divider"></div>
      <button type="submit" name="action" value="trigger_calls" class="bulk-btn">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
        Trigger Calls
      </button>
      <div class="bulk-divider"></div>
      <button type="submit" name="action" value="delete" class="bulk-btn bulk-btn-danger"
              onclick="return confirm('Delete selected applications? This cannot be undone.')">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path></svg>
        Delete
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-header-title">All Applications</h2>
    </div>
    <div class="table-responsive">
      <table class="table mb-0">
        <thead>
          <tr>
            <th style="width:2.5rem; padding-left:1.1rem;" class="no-row-click">
              <input type="checkbox" class="form-check-input" id="select-all" title="Select all">
            </th>
            <th>Candidate</th>
            <th>Position</th>
            <th>Status</th>
            <th class="text-center">Score</th>
            <th>Next Call</th>
            <th>Last Activity</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for app in applications %}
          <tr data-href="{% url 'applications:detail' app.pk %}">
            <td style="padding-left:1.1rem;" class="no-row-click">
              <input type="checkbox" class="form-check-input row-check" name="application_ids" value="{{ app.pk }}">
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="initials-circle">
                  {{ app.candidate.full_name|default:"—"|make_list|first|upper }}
                </div>
                <div>
                  <div class="fw-medium">{{ app.candidate.full_name }}</div>
                  <div class="text-xs text-muted-custom">{{ app.candidate.phone }}</div>
                </div>
              </div>
            </td>
            <td class="text-sm">{{ app.position.title }}</td>
            <td>{% include "applications/_status_badge.html" with status=app.status %}</td>
            <td class="text-center">
              {% if app.score is not None %}
                <span class="{% if app.qualified %}score-pass{% else %}score-fail{% endif %} tabular-nums">{{ app.score }}</span>
              {% else %}
                <span class="text-muted-custom">&mdash;</span>
              {% endif %}
            </td>
            <td class="text-xs">
              {% if app.callback_scheduled_at %}
                <span style="color:var(--accent-primary);">{{ app.callback_scheduled_at|date:"M j, H:i" }}</span>
              {% else %}
                <span class="text-muted-custom">&mdash;</span>
              {% endif %}
            </td>
            <td class="text-xs text-muted-custom">{{ app.updated_at|timesince }} ago</td>
            <td class="text-end no-row-click">
              <a href="{% url 'applications:detail' app.pk %}" class="btn btn-secondary btn-sm">View</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-5">
              <div class="empty-state-icon mx-auto mb-3">
                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
              </div>
              <div class="empty-state-title">No applications found</div>
              <div class="empty-state-desc">Try adjusting your filters.</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
    <div class="card-body border-top d-flex justify-content-between align-items-center py-2" style="border-color: var(--border-default) !important;">
      <div class="text-sm text-tertiary">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </div>
      <div class="d-flex gap-2">
        {% if page_obj.has_previous %}
        <a class="btn btn-secondary btn-sm" href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">&larr; Prev</a>
        {% else %}
        <button class="btn btn-secondary btn-sm" disabled>&larr; Prev</button>
        {% endif %}
        {% if page_obj.has_next %}
        <a class="btn btn-secondary btn-sm" href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">Next &rarr;</a>
        {% else %}
        <button class="btn btn-secondary btn-sm" disabled>Next &rarr;</button>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
(function () {
  const raw = JSON.parse(document.getElementById('applist-chart-data').textContent);
  const root = getComputedStyle(document.documentElement);
  const textMuted   = root.getPropertyValue('--text-muted').trim()   || '#94a3b8';
  const borderLight = root.getPropertyValue('--border-light').trim() || '#e2e8f0';

  new Chart(document.getElementById('applist-activity-chart'), {
    type: 'bar',
    data: {
      labels: raw.labels,
      datasets: raw.datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          align: 'end',
          labels: {
            color: textMuted,
            font: { size: 11, weight: '600' },
            boxWidth: 10,
            boxHeight: 10,
            borderRadius: 3,
            useBorderRadius: true,
            padding: 12,
            // Hide the "__" prefixed unqualified datasets from the legend
            filter: (item) => !item.text.startsWith('__'),
          },
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: '#1e293b',
          titleColor: '#f8fafc',
          bodyColor: '#cbd5e1',
          padding: 10,
          cornerRadius: 6,
          // Only show items that have data; group the pair into one line per position
          // Only show the vivid bar segment (qualified) rows; skip hidden/trend datasets
          filter: (item) => !item.dataset.label.startsWith('__'),
          callbacks: {
            label: (item) => {
              // For each position's qualified bar, also look up the unqualified bar
              // (it sits two datasets back: unqual, qual, trend → qual is at dsIdx, unqual at dsIdx-1... but now trend is dsIdx+1)
              // Datasets are grouped as: [unqual_bar, qual_bar, trend_line] per position
              // qual_bar is at index 3k+1; unqual_bar is at 3k
              const dsIdx = item.datasetIndex;
              const unqualDs = raw.datasets[dsIdx - 1];
              const unqual = unqualDs ? (unqualDs.data[item.dataIndex] || 0) : 0;
              const qual   = item.parsed.y || 0;
              const total  = unqual + qual;
              if (total === 0) return null;
              return ` ${item.dataset.label}: ${total} total, ${qual} qualified`;
            },
          },
        },
      },
      scales: {
        x: {
          stacked: true,
          grid: { display: false },
          ticks: { color: textMuted, font: { size: 11 } },
        },
        y: {
          stacked: true,
          beginAtZero: true,
          grid: { color: borderLight },
          ticks: { color: textMuted, font: { size: 11 }, precision: 0 },
        },
      },
    },
  });
})();
</script>
<script>initBulkSelect('.row-check', 'select-all', 'bulk-bar', 'bulk-count');</script>
{% endblock %}
