{% extends "base.html" %}
{% block title %}Applications — RecruitFlow{% endblock %}
{% block breadcrumb %}Applications{% endblock %}
{% block page_title %}Applications{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Position</label>
        <select name="position" class="form-select">
          <option value="">All positions</option>
          {% for pos in positions %}
          <option value="{{ pos.pk }}" {% if current_filters.position == pos.pk|stringformat:"d" %}selected{% endif %}>{{ pos.title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Status</label>
        <select name="status" class="form-select">
          <option value="">All statuses</option>
          {% for value, label in status_choices %}
          <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Qualified</label>
        <select name="qualified" class="form-select">
          <option value="">Any</option>
          <option value="true" {% if current_filters.qualified == "true" %}selected{% endif %}>Yes</option>
          <option value="false" {% if current_filters.qualified == "false" %}selected{% endif %}>No</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">From</label>
        <input type="date" name="date_from" value="{{ current_filters.date_from }}" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">To</label>
        <input type="date" name="date_to" value="{{ current_filters.date_to }}" class="form-control">
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<form method="post" action="{% url 'applications:trigger_calls' %}" id="bulk-form">
  {% csrf_token %}

  <div id="bulk-bar" class="d-flex align-items-center justify-content-between mb-3 px-4 py-3" style="display:none!important; background: linear-gradient(135deg, #4318FF, #7551FF); color: white; border-radius: var(--radius-lg); box-shadow: 0 4px 15px rgba(67,24,255,0.25);">
    <span class="text-base fw-semibold"><strong id="bulk-count">0</strong> application(s) selected</span>
    <button type="submit" class="btn btn-sm d-inline-flex align-items-center gap-2" style="background: rgba(255,255,255,0.18); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: var(--radius-sm);">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
      Trigger Calls
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-header-title">All Applications</h2>
    </div>
    <div class="table-responsive">
      <table class="table mb-0">
        <thead>
          <tr>
            <th style="width:2.5rem; padding-left: 1.1rem;">
              <input type="checkbox" class="form-check-input" id="select-all" title="Select all pending_call applications">
            </th>
            <th>Candidate</th>
            <th>Position</th>
            <th>Status</th>
            <th class="text-center">Score</th>
            <th>Last Activity</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for app in applications %}
          <tr>
            <td style="padding-left: 1.1rem;">
              {% if app.status == "pending_call" %}
              <input type="checkbox" class="form-check-input row-check" name="application_ids" value="{{ app.pk }}">
              {% endif %}
            </td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <div class="initials-circle">
                  {{ app.candidate.full_name|default:"—"|make_list|first|upper }}
                </div>
                <div>
                  <div class="fw-medium">{{ app.candidate.full_name }}</div>
                  <div class="text-xs text-muted-custom">{{ app.candidate.phone }}</div>
                </div>
              </div>
            </td>
            <td class="text-sm">{{ app.position.title }}</td>
            <td>{% include "applications/_status_badge.html" with status=app.status %}</td>
            <td class="text-center">
              {% if app.score is not None %}
                <span class="{% if app.qualified %}score-pass{% else %}score-fail{% endif %}">{{ app.score }}</span>
              {% else %}
                <span class="text-muted-custom">&mdash;</span>
              {% endif %}
            </td>
            <td class="text-xs text-muted-custom">{{ app.updated_at|timesince }} ago</td>
            <td class="text-end">
              <a href="{% url 'applications:detail' app.pk %}" class="btn btn-secondary btn-sm">View</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center py-5">
              <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" class="text-tertiary mb-3"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
              <div class="empty-state-title">No applications found</div>
              <div class="empty-state-desc">Try adjusting your filters.</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
    <div class="card-body border-top d-flex justify-content-between align-items-center py-2" style="border-color: var(--border-light) !important;">
      <div class="text-sm text-tertiary">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </div>
      <div class="d-flex gap-2">
        {% if page_obj.has_previous %}
        <a class="btn btn-secondary btn-sm" href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}">&larr; Previous</a>
        {% else %}
        <button class="btn btn-secondary btn-sm" disabled>&larr; Previous</button>
        {% endif %}
        
        {% if page_obj.has_next %}
        <a class="btn btn-secondary btn-sm" href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}">Next &rarr;</a>
        {% else %}
        <button class="btn btn-secondary btn-sm" disabled>Next &rarr;</button>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const selectAll = document.getElementById('select-all');
  const bulkBar = document.getElementById('bulk-bar');
  const bulkCount = document.getElementById('bulk-count');
  const checks = document.querySelectorAll('.row-check');

  function updateBar() {
    const checked = document.querySelectorAll('.row-check:checked').length;
    bulkCount.textContent = checked;
    bulkBar.style.cssText = checked > 0 ? 'background: linear-gradient(135deg,#4318FF,#7551FF); color: white; border-radius: var(--radius-lg,16px); box-shadow: 0 4px 15px rgba(67,24,255,0.25); display:flex!important;' : 'display:none!important';
  }

  if(selectAll) {
    selectAll.addEventListener('change', function() {
      checks.forEach(c => c.checked = selectAll.checked);
      updateBar();
    });
  }

  checks.forEach(c => c.addEventListener('change', updateBar));
})();
</script>
{% endblock %}
