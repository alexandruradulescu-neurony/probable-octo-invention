{% extends "base.html" %}
{% load rf_tags %}
{% block title %}{{ candidate.full_name }} — {{ position.title }} — RecruitFlow{% endblock %}
{% block breadcrumb %}Applications{% endblock %}
{% block page_title %}{{ candidate.full_name }}{% endblock %}

{% block extra_css %}
<style>
/* ── Call History ─────────────────────────────────────────────────── */
.call-item {
  padding: 1.1rem 1.5rem;
  border-bottom: 1px solid var(--border-light);
}
.call-item:last-child { border-bottom: none; }

.call-attempt-badge {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 1.5px solid var(--border-default);
  background: var(--bg-page);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.68rem;
  font-weight: 700;
  color: var(--text-muted);
  flex-shrink: 0;
}

.call-meta-row {
  display: flex;
  align-items: center;
  gap: 0.9rem;
  margin-top: 0.35rem;
  flex-wrap: wrap;
}

.call-meta-item {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.78rem;
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
}

/* ── Messages ─────────────────────────────────────────────────────── */
.msg-dir {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.msg-dir-out { background: var(--bg-page); border: 1px solid var(--border-default); }
.msg-dir-in  { background: var(--accent-primary-pale); }

/* ── Quick-action sections ────────────────────────────────────────── */
.action-section {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border-light);
}
.action-section:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block topbar_actions %}
<div class="d-flex align-items-center gap-2">
  <form method="post" action="{% url 'applications:call_now' application.pk %}" class="m-0">
    {% csrf_token %}
    <button type="submit" class="btn btn-primary d-inline-flex align-items-center gap-2"
            onclick="return confirm('Initiate a call to {{ candidate.phone }} right now?')">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
      Call Now
    </button>
  </form>
  <a href="{% url 'applications:list' %}" class="btn btn-secondary d-inline-flex align-items-center gap-2">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
    Back
  </a>
</div>
{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- ── Left column ─────────────────────────────────────────────── -->
  <div class="col-lg-8">

    <!-- ── Candidate Hero Header ──────────────────────────────────── -->
    <div class="card candidate-header-card mb-4 card-hero">
      <div class="candidate-header-stripe"></div>
      <div class="card-body" style="padding:1.5rem;">
        <div class="d-flex align-items-start gap-4 flex-wrap">
          <div class="initials-circle initials-circle-xl flex-shrink-0"
               style="background:var(--gradient-primary);color:#fff;">
            {{ candidate.full_name|default:"?"|make_list|first|upper }}
          </div>
          <div style="flex:1;min-width:160px;">
            <div style="font-size:1.25rem;font-weight:800;letter-spacing:-0.025em;color:var(--text-primary);line-height:1.2;margin-bottom:0.2rem;">
              {{ candidate.full_name }}
            </div>
            <div class="text-sm text-tertiary mb-3" style="font-weight:500;">{{ position.title }}</div>
            <div class="d-flex gap-2 flex-wrap align-items-center">
              {% include "applications/_status_badge.html" with status=application.status %}
              {% if application.qualified is not None %}
                {% if application.qualified %}
                  <div class="badge status-offered"><span class="badge-dot"></span> Qualified</div>
                {% else %}
                  <div class="badge status-rejected"><span class="badge-dot"></span> Not Qualified</div>
                {% endif %}
              {% endif %}
              {% if application.score is not None %}
                <div class="badge badge-neutral tabular-nums">{{ application.score }}/100</div>
              {% endif %}
            </div>
          </div>
          <div class="candidate-contact-col d-flex flex-column">
            <div class="info-row">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" class="text-tertiary"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
              <a href="tel:{{ candidate.phone }}" class="contact-link">{{ candidate.phone }}</a>
            </div>
            <div class="info-row">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" class="text-tertiary"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
              <a href="mailto:{{ candidate.email }}" class="contact-link">{{ candidate.email }}</a>
            </div>
            {% if candidate.whatsapp_number %}
            <div class="info-row">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="color:var(--accent-positive);"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
              <a href="https://wa.me/{{ candidate.whatsapp_number }}" target="_blank" class="contact-link">{{ candidate.whatsapp_number }}</a>
            </div>
            {% endif %}
            {% with cv_uploads|first as latest_cv %}
            {% if latest_cv and latest_cv.file_path %}
            <div class="info-row">
              <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="color:var(--accent-negative);"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              <a href="/{{ latest_cv.file_path }}" download="{{ latest_cv.file_name }}" class="contact-link">Download CV</a>
            </div>
            {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>
    </div>

    <!-- ── Call History ────────────────────────────────────────────── -->
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="card-header-title">Call History</h2>
        {% if calls %}<span class="badge badge-neutral tabular-nums">{{ calls|length }}</span>{% endif %}
      </div>

      {% if calls %}
      <div>
        {% for call in calls %}
        <div class="call-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <div class="call-attempt-badge">{{ call.attempt_number }}</div>
              {% if call.status == "completed" %}
                <div class="badge status-offered"><span class="badge-dot"></span> Completed</div>
              {% elif call.status == "initiated" or call.status == "in_progress" %}
                <div class="badge status-interview"><span class="badge-dot"></span> {{ call.get_status_display }}</div>
              {% else %}
                <div class="badge status-rejected"><span class="badge-dot"></span> {{ call.get_status_display }}</div>
              {% endif %}
              {% if call.summary_title %}
              <span class="fw-semibold text-sm">{{ call.summary_title }}</span>
              {% endif %}
            </div>
            {% if call.transcript %}
            <a class="text-xs fw-semibold text-decoration-none d-inline-flex align-items-center gap-1 flex-shrink-0"
               style="color:var(--accent-primary);"
               data-bs-toggle="collapse" href="#transcript-{{ call.pk }}" role="button">
              <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
              View Transcript
            </a>
            {% endif %}
          </div>

          <div class="call-meta-row">
            <div class="call-meta-item">
              <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              {{ call.initiated_at|date:"M j, Y · H:i" }}
            </div>
            {% if call.duration_seconds %}
            <div class="call-meta-item">
              <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              {{ call.duration_seconds }}s
            </div>
            {% endif %}
          </div>

          {% if call.summary %}
          <div class="text-sm mt-2" style="color:var(--text-secondary);line-height:1.65;">{{ call.summary }}</div>
          {% endif %}

          {% if call.transcript %}
          <div class="collapse mt-2" id="transcript-{{ call.pk }}">
            <div style="background:var(--bg-page);border:1px solid var(--border-default);border-radius:var(--radius-md);padding:0.85rem 1rem;white-space:pre-line;max-height:300px;overflow-y:auto;font-size:0.85rem;line-height:1.7;color:var(--text-secondary);">{{ call.transcript }}</div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="card-body text-center py-5">
        <div class="empty-state-icon mx-auto mb-3">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
        </div>
        <div class="empty-state-title">No calls yet</div>
        <div class="empty-state-desc">No calls have been made to this candidate.</div>
      </div>
      {% endif %}
    </div>

    <!-- ── AI Evaluations ─────────────────────────────────────────── -->
    {% for call in calls %}
      {% for ev in call.evaluations.all %}
      <div class="card mb-4">
        <div class="card-header">
          <h2 class="card-header-title">AI Evaluation</h2>
          <div class="d-flex align-items-center gap-2">
            {% if ev.outcome == "qualified" %}
              <div class="badge status-offered"><span class="badge-dot"></span> Qualified</div>
            {% elif ev.outcome == "not_qualified" %}
              <div class="badge status-rejected"><span class="badge-dot"></span> Not Qualified</div>
            {% elif ev.outcome == "callback_requested" %}
              <div class="badge status-review"><span class="badge-dot"></span> Callback Requested</div>
            {% elif ev.outcome == "needs_human" %}
              <div class="badge status-screening"><span class="badge-dot"></span> Needs Human</div>
            {% endif %}
          </div>
        </div>

        <div class="card-body">
          <div class="d-flex gap-0 align-items-start">

            <!-- Score gauge -->
            {% with arc_filled=ev.score|score_arc stroke_color=ev.outcome|score_stroke_color %}
            <div class="eval-gauge-wrap">
              <div style="position:relative;width:88px;height:88px;">
                <svg class="eval-gauge-svg" viewBox="0 0 80 80">
                  <circle cx="40" cy="40" r="34" fill="none" stroke="var(--border-default)" stroke-width="5"/>
                  <circle cx="40" cy="40" r="34" fill="none"
                          stroke="{{ stroke_color }}"
                          stroke-width="5"
                          stroke-dasharray="{{ arc_filled }} 214"
                          stroke-linecap="round"
                          transform="rotate(-90 40 40)"/>
                </svg>
                <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;">
                  <span class="eval-gauge-score">{{ ev.score }}</span>
                  <span class="eval-gauge-denom">/100</span>
                </div>
              </div>
              <span class="eval-gauge-label">Overall Score</span>
            </div>
            {% endwith %}

            <!-- Criteria list or reasoning fallback -->
            <div class="eval-criteria-list">
              {% if ev.raw_response.criteria %}
                {% for criterion in ev.raw_response.criteria %}
                <div class="eval-criterion">
                  <div class="eval-criterion-icon {% if criterion.passed %}eval-criterion-pass{% else %}eval-criterion-fail{% endif %}">
                    {% if criterion.passed %}
                    <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    {% else %}
                    <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    {% endif %}
                  </div>
                  <div>
                    <div class="eval-criterion-name">{{ criterion.name }}</div>
                    {% if criterion.note %}
                    <div class="eval-criterion-note">{{ criterion.note }}</div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              {% else %}
                {# Fallback for evaluations without structured criteria #}
                <div class="text-sm" style="color:var(--text-secondary);line-height:1.65;">{{ ev.reasoning }}</div>
              {% endif %}
            </div>

          </div>

          {# Disqualifying factor #}
          {% if ev.raw_response.disqualifying_factor %}
          <div class="eval-disqualifying">
            <div class="eval-disqualifying-label">Disqualifying Factor</div>
            <div class="eval-disqualifying-text">{{ ev.raw_response.disqualifying_factor }}</div>
          </div>
          {% endif %}

          {# Callback info #}
          {% if ev.callback_requested and ev.callback_notes %}
          <div class="eval-callback-box">
            <strong>Callback:</strong> {{ ev.callback_notes }}
          </div>
          {% endif %}

          {# Human escalation #}
          {% if ev.needs_human and ev.needs_human_notes %}
          <div style="margin-top:0.75rem;padding:0.65rem 0.9rem;background:rgba(249,115,22,0.06);border:1px solid rgba(249,115,22,0.2);border-left:3px solid #F97316;border-radius:var(--radius-md);font-size:0.82rem;color:#7C2D12;line-height:1.5;">
            <strong>Escalation:</strong> {{ ev.needs_human_notes }}
          </div>
          {% endif %}

        </div>
      </div>
      {% endfor %}
    {% endfor %}

    <!-- ── Pre-screening Answers + Candidate Details + CV (tabbed) ── -->
    <div class="card mb-4">
      <div class="card-header" style="padding-bottom:0;border-bottom:none;">
        <div>
          <ul class="nav rf-tabs" id="prescreening-tabs" role="tablist">
            {% if form_answers_list %}
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-prescreening" data-bs-toggle="tab" data-bs-target="#pane-prescreening" type="button" role="tab">
                Pre-screening Answers
              </button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if not form_answers_list %}active{% endif %}" id="tab-details" data-bs-toggle="tab" data-bs-target="#pane-details" type="button" role="tab">
                Candidate Details
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-cv" data-bs-toggle="tab" data-bs-target="#pane-cv" type="button" role="tab">
                Curriculum Vitae
                {% if cv_uploads %}<span class="badge badge-neutral tabular-nums ms-1">{{ cv_uploads|length }}</span>{% endif %}
              </button>
            </li>
          </ul>
        </div>
      </div>
      <div style="border-top:1px solid var(--border-light);">
        <div class="tab-content rf-tabs-content">

          {# Pre-screening Answers pane #}
          {% if form_answers_list %}
          <div class="tab-pane fade show active" id="pane-prescreening" role="tabpanel">
            {% for qa in form_answers_list %}
            <div style="padding:0.75rem 1.25rem;border-bottom:1px solid var(--border-light);">
              <div class="text-xs fw-semibold text-tertiary mb-1" style="text-transform:uppercase;letter-spacing:.05em;">{{ qa.question }}</div>
              <div class="text-sm fw-medium">{{ qa.answer }}</div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {# Candidate Details pane #}
          <div class="tab-pane fade {% if not form_answers_list %}show active{% endif %}" id="pane-details" role="tabpanel">
            <table class="table meta-table mb-0">
              <tbody>
                <tr><td>ID</td><td class="tabular-nums">#{{ application.pk }}</td></tr>
                <tr><td>Created</td><td class="tabular-nums">{{ application.created_at|date:"M j, Y H:i" }}</td></tr>
                <tr><td>Updated</td><td class="tabular-nums">{{ application.updated_at|date:"M j, Y H:i" }}</td></tr>
                {% if application.cv_received_at %}
                <tr><td>CV Received</td><td class="tabular-nums">{{ application.cv_received_at|date:"M j, Y H:i" }}</td></tr>
                {% endif %}
                {% if application.callback_scheduled_at %}
                <tr><td>Callback At</td><td class="tabular-nums">{{ application.callback_scheduled_at|date:"M j, Y H:i" }}</td></tr>
                {% endif %}
                <tr><td colspan="2" style="padding:0;height:1px;background:var(--border-default);"></td></tr>
                <tr><td>Source</td><td>{{ candidate.get_source_display }}</td></tr>
                {% if candidate.campaign_name %}
                <tr><td>Campaign</td><td>{{ candidate.campaign_name }}</td></tr>
                {% endif %}
                {% if candidate.platform %}
                <tr><td>Platform</td><td>{{ candidate.platform|upper }}</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          {# Curriculum Vitae pane #}
          <div class="tab-pane fade" id="pane-cv" role="tabpanel">
            <div style="padding:1.1rem 1.25rem;">
              {% if cv_uploads %}
              <div class="d-flex flex-column gap-2 mb-3">
                {% for cv in cv_uploads %}
                <div class="d-flex align-items-center justify-content-between gap-2 p-2"
                     style="background:var(--bg-page);border:1px solid var(--border-default);border-radius:var(--radius-md);">
                  <div class="d-flex align-items-center gap-2 overflow-hidden">
                    <svg width="13" height="13" fill="none" stroke="var(--accent-negative)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" class="flex-shrink-0"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                    <div class="overflow-hidden">
                      <div class="text-sm fw-medium text-truncate" title="{{ cv.file_name }}">{{ cv.file_name }}</div>
                      <div class="text-xs text-tertiary">{{ cv.received_at|date:"M j, Y" }} &middot; {{ cv.get_source_display }}{% if cv.match_method %} &middot; {{ cv.get_match_method_display }}{% endif %}</div>
                    </div>
                  </div>
                  <div class="d-flex align-items-center gap-1 flex-shrink-0">
                    {% if cv.needs_review %}
                    <div class="badge status-screening">Review</div>
                    {% endif %}
                    {% if cv.file_path %}
                    <a href="/{{ cv.file_path }}" download="{{ cv.file_name }}"
                       class="btn btn-secondary btn-sm d-inline-flex align-items-center gap-1">
                      <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                      Download
                    </a>
                    {% else %}
                    <span class="text-xs text-secondary">No file</span>
                    {% endif %}
                    <form method="post" action="{% url 'cvs:cv_delete' cv.pk %}" class="m-0"
                          onsubmit="return confirm('Delete this CV? This cannot be undone.');">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.path }}">
                      <button type="submit" class="btn-icon-delete" title="Delete CV">
                        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4h6v2"></path></svg>
                      </button>
                    </form>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}
              <form method="post" action="{% url 'applications:upload_cv' application.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <label class="form-label" style="text-transform:none;letter-spacing:0;">Upload New CV</label>
                {{ manual_cv_upload_form.cv_file }}
                <button type="submit" class="btn btn-secondary w-100 mt-2">Upload</button>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- ── Right column ─────────────────────────────────────────────── -->
  <div class="col-lg-4">

    <!-- Quick Actions -->
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="card-header-title">Quick Actions</h2>
      </div>

      <div class="action-section">
        <div class="action-section-label">Change Status</div>
        <form method="post" action="{% url 'applications:override_status' application.pk %}">
          {% csrf_token %}
          <div class="d-flex flex-column gap-2">
            {{ status_override_form.new_status }}
            {{ status_override_form.reason }}
            <button type="submit" class="btn btn-secondary btn-sm w-100">Update Status</button>
          </div>
        </form>
      </div>

      <div class="action-section">
        <div class="action-section-label">Schedule Callback</div>
        <form method="post" action="{% url 'applications:schedule_callback' application.pk %}">
          {% csrf_token %}
          <div class="d-flex flex-column gap-2">
            {{ schedule_callback_form.callback_at }}
            {{ schedule_callback_form.note }}
            <button type="submit" class="btn btn-secondary btn-sm w-100 d-inline-flex align-items-center justify-content-center gap-2">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              Schedule
            </button>
          </div>
        </form>
      </div>

      <div class="action-section">
        <div class="action-section-label">Send Reminder</div>
        <form method="post" action="{% url 'applications:trigger_followup' application.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-secondary btn-sm w-100 d-inline-flex align-items-center justify-content-center gap-2">
            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            Send CV Follow-up
          </button>
        </form>
        <div class="text-xs text-tertiary mt-2">Sends a WhatsApp &amp; email nudge to submit CV.</div>
      </div>
    </div>

    <!-- All Events + Messages (tabbed) -->
    <div class="card mb-4">
      <div class="card-header" style="padding-bottom:0;border-bottom:none;">
        <div>
          <ul class="nav rf-tabs" id="activity-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-events" data-bs-toggle="tab" data-bs-target="#pane-events" type="button" role="tab">
                All Events
                {% if status_changes %}<span class="badge badge-neutral tabular-nums ms-1">{{ status_changes|length }}</span>{% endif %}
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-messages" data-bs-toggle="tab" data-bs-target="#pane-messages" type="button" role="tab">
                Messages
                {% with unread=candidate_replies|length %}{% if unread %}<span class="badge status-screening ms-1"><span class="badge-dot"></span>{{ unread }}</span>{% endif %}{% endwith %}
              </button>
            </li>
          </ul>
        </div>
      </div>
      <div style="border-top:1px solid var(--border-light);">
        <div class="tab-content rf-tabs-content">

          {# All Events pane #}
          <div class="tab-pane fade show active" id="pane-events" role="tabpanel">
            {% if status_changes %}
            <div class="activity-list py-1">
              {% for sc in status_changes %}
              <div class="activity-row" style="cursor:default;align-items:flex-start;">
                <div class="activity-dot-col">
                  {% with dot_color=sc.to_status|status_dot_color %}
                  <div class="activity-dot-colored" style="background:{{ dot_color }};border-color:{{ dot_color }};opacity:0.85;"></div>
                  {% endwith %}
                  {% if not forloop.last %}<div class="activity-connector"></div>{% endif %}
                </div>
                <div class="activity-body">
                  {% if sc.from_status != sc.to_status %}
                  <div class="activity-who d-flex align-items-center gap-2 flex-wrap">
                    <strong>{{ sc.get_to_status_display }}</strong>
                  </div>
                  {% else %}
                  <div class="activity-who"><strong>Note</strong></div>
                  {% endif %}
                  {% if sc.note %}
                  <div class="timeline-subtitle">{{ sc.note }}</div>
                  {% endif %}
                  <div class="timeline-meta">
                    {{ sc.changed_at|date:"M j, Y · H:i" }}
                    {% if sc.changed_by %}&middot; {{ sc.changed_by.get_full_name|default:sc.changed_by.username }}{% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="card-body text-center py-4">
              <div class="text-sm text-tertiary">No events yet.</div>
            </div>
            {% endif %}
          </div>

          {# Messages pane #}
          <div class="tab-pane fade" id="pane-messages" role="tabpanel">
            {% if sent_messages or candidate_replies %}
            <div class="table-responsive">
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th style="width:28px;"></th>
                    <th>Ch.</th>
                    <th>Content</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for msg in sent_messages %}
                  <tr>
                    <td class="ps-3">
                      <div class="msg-dir msg-dir-out" title="Outbound">
                        <svg width="10" height="10" fill="none" stroke="var(--text-muted)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                      </div>
                    </td>
                    <td>
                      {% if msg.channel == "email" %}
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" class="text-tertiary" title="Email"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                      {% else %}
                        <svg width="12" height="12" fill="none" stroke="var(--accent-positive)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" title="WhatsApp"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                      {% endif %}
                    </td>
                    <td class="text-sm text-secondary">
                      {{ msg.get_message_type_display }}
                      <div class="text-xs text-muted-custom tabular-nums">{{ msg.sent_at|date:"M j · H:i"|default:"—" }}</div>
                    </td>
                    <td>
                      {% if msg.status == "sent" or msg.status == "delivered" %}
                        <div class="badge status-offered"><span class="badge-dot"></span> {{ msg.get_status_display }}</div>
                      {% elif msg.status == "failed" %}
                        <div class="badge status-rejected"><span class="badge-dot"></span> Failed</div>
                      {% else %}
                        <div class="badge status-screening"><span class="badge-dot"></span> {{ msg.get_status_display }}</div>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                  {% for reply in candidate_replies %}
                  <tr {% if not reply.is_read %}style="background:var(--bg-page);"{% endif %}>
                    <td class="ps-3">
                      <div class="msg-dir msg-dir-in" title="From candidate">
                        <svg width="10" height="10" fill="none" stroke="var(--accent-primary)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                      </div>
                    </td>
                    <td>
                      {% if reply.channel == "email" %}
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" class="text-tertiary" title="Email"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                      {% else %}
                        <svg width="12" height="12" fill="none" stroke="var(--accent-positive)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" title="WhatsApp"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                      {% endif %}
                    </td>
                    <td style="max-width:160px;">
                      {% if reply.subject %}
                      <div class="text-xs text-muted-custom mb-1">{{ reply.subject|truncatechars:40 }}</div>
                      {% endif %}
                      <div class="text-sm">{{ reply.body|truncatechars:60 }}</div>
                      <div class="text-xs text-muted-custom tabular-nums">{{ reply.received_at|date:"M j · H:i" }}</div>
                    </td>
                    <td>
                      <div class="d-flex align-items-center gap-1">
                        {% if not reply.is_read %}
                        <span style="width:6px;height:6px;border-radius:50%;background:var(--accent-primary);flex-shrink:0;display:inline-block;" title="Unread"></span>
                        {% endif %}
                        <form method="post" action="{% url 'messaging:reply_read' reply.pk %}?next={{ request.path }}" class="m-0">
                          {% csrf_token %}
                          <button type="submit" class="btn-icon-delete" title="Mark as read" style="color:var(--accent-positive);border-color:rgba(16,185,129,0.3);">
                            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="card-body text-center py-4">
              <div class="text-sm text-tertiary">No messages yet.</div>
            </div>
            {% endif %}
          </div>

        </div>
      </div>
    </div>

    <!-- Internal Note -->
    <div class="card mb-4">
      <div class="card-header">
        <h2 class="card-header-title">Internal Note</h2>
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'applications:add_note' application.pk %}">
          {% csrf_token %}
          {{ add_note_form.note }}
          <button type="submit" class="btn btn-secondary btn-sm w-100 mt-2">Save Note</button>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}
