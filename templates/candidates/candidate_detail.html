{% extends "base.html" %}
{% block title %}{{ candidate.full_name }} — RecruitFlow{% endblock %}
{% block page_title %}Candidate Detail{% endblock %}

{% block topbar_actions %}
<a href="{% url 'candidates:list' %}" class="btn btn-sm btn-outline-secondary">
  <i class="bi bi-arrow-left"></i> Back to List
</a>
{% endblock %}

{% block content %}

<!-- Header -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <!-- Display mode -->
    <div id="contact-display">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h4 class="mb-1">{{ candidate.full_name }}</h4>
          <span class="badge {% if candidate.source == 'meta_form' %}bg-primary{% else %}bg-secondary{% endif %} bg-opacity-75 badge-status">
            {{ candidate.get_source_display }}
          </span>
          {% if candidate.campaign_name %}
          <span class="badge bg-info bg-opacity-75 badge-status ms-1">{{ candidate.campaign_name }}</span>
          {% endif %}
        </div>
        <div class="col-md-6 text-md-end mt-2 mt-md-0">
          {% if candidate.phone %}
          <a href="tel:{{ candidate.phone }}" class="btn btn-sm btn-outline-success me-1" title="Call">
            <i class="bi bi-telephone"></i> {{ candidate.phone }}
          </a>
          {% endif %}
          {% if candidate.email %}
          <a href="mailto:{{ candidate.email }}" class="btn btn-sm btn-outline-primary me-1" title="Email">
            <i class="bi bi-envelope"></i> {{ candidate.email }}
          </a>
          {% endif %}
          {% if candidate.phone %}
          <a href="https://wa.me/{{ candidate.whatsapp_number|default:candidate.phone }}"
             class="btn btn-sm btn-outline-success me-1" target="_blank" title="WhatsApp">
            <i class="bi bi-whatsapp"></i>
          </a>
          {% endif %}
          <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-edit-contact">
            <i class="bi bi-pencil"></i> Edit
          </button>
        </div>
      </div>
    </div>

    <!-- Edit mode -->
    <div id="contact-edit" style="display:none">
      <form method="post" action="{% url 'candidates:update_contact' candidate.pk %}">
        {% csrf_token %}
        <div class="row g-2 align-items-end">
          <div class="col-md-2">
            <label class="form-label small mb-0">First Name</label>
            {{ contact_form.first_name }}
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-0">Last Name</label>
            {{ contact_form.last_name }}
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-0">Phone</label>
            {{ contact_form.phone }}
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-0">Email</label>
            {{ contact_form.email }}
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-0">WhatsApp</label>
            {{ contact_form.whatsapp_number }}
          </div>
          <div class="col-md-1 d-flex gap-1">
            <button type="submit" class="btn btn-sm btn-dark"><i class="bi bi-check-lg"></i></button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-cancel-edit"><i class="bi bi-x-lg"></i></button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Left column -->
  <div class="col-lg-7">

    <!-- Applications -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-kanban"></i> Applications ({{ applications|length }})
      </div>
      {% if applications %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Position</th>
              <th>Status</th>
              <th class="text-center">Score</th>
              <th>Last Activity</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for app in applications %}
            <tr>
              <td class="fw-medium">{{ app.position.title }}</td>
              <td>{% include "applications/_status_badge.html" with application=app %}</td>
              <td class="text-center">
                {% if app.score is not None %}
                <span class="fw-semibold">{{ app.score }}</span>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td class="small text-muted">{{ app.updated_at|timesince }} ago</td>
              <td>
                <a href="{% url 'applications:detail' app.pk %}" class="btn btn-sm btn-outline-secondary">
                  View
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="card-body text-muted text-center py-4">
        No applications yet.
      </div>
      {% endif %}
    </div>

    <!-- Form Answers -->
    {% if form_answers_list %}
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-chat-square-text"></i> Pre-screening Answers
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <tbody>
            {% for qa in form_answers_list %}
            <tr>
              <td class="fw-medium text-muted small" style="width:45%">{{ qa.question }}</td>
              <td class="small">{{ qa.answer }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

  </div>

  <!-- Right column -->
  <div class="col-lg-5">

    <!-- Meta Info -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-info-circle"></i> Candidate Info
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0">
          <tbody>
            <tr>
              <td class="text-muted small fw-medium">ID</td>
              <td class="small">{{ candidate.pk }}</td>
            </tr>
            {% if candidate.meta_lead_id %}
            <tr>
              <td class="text-muted small fw-medium">Meta Lead ID</td>
              <td class="small font-monospace">{{ candidate.meta_lead_id }}</td>
            </tr>
            {% endif %}
            <tr>
              <td class="text-muted small fw-medium">Source</td>
              <td class="small">{{ candidate.get_source_display }}</td>
            </tr>
            {% if candidate.campaign_name %}
            <tr>
              <td class="text-muted small fw-medium">Campaign</td>
              <td class="small">{{ candidate.campaign_name }}</td>
            </tr>
            {% endif %}
            {% if candidate.platform %}
            <tr>
              <td class="text-muted small fw-medium">Platform</td>
              <td class="small">{{ candidate.platform|upper }}</td>
            </tr>
            {% endif %}
            {% if candidate.meta_created_time %}
            <tr>
              <td class="text-muted small fw-medium">Submitted</td>
              <td class="small">{{ candidate.meta_created_time|date:"d M Y H:i" }}</td>
            </tr>
            {% endif %}
            <tr>
              <td class="text-muted small fw-medium">Created</td>
              <td class="small">{{ candidate.created_at|date:"d M Y H:i" }}</td>
            </tr>
            <tr>
              <td class="text-muted small fw-medium">Updated</td>
              <td class="small">{{ candidate.updated_at|date:"d M Y H:i" }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Notes -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-journal-text"></i> Notes
      </div>
      <div class="card-body">
        <form method="post" action="{% url 'candidates:update_notes' candidate.pk %}">
          {% csrf_token %}
          {{ note_form.notes }}
          <button type="submit" class="btn btn-sm btn-primary mt-2">
            <i class="bi bi-save"></i> Save Notes
          </button>
        </form>
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById('btn-edit-contact').addEventListener('click', function() {
  document.getElementById('contact-display').style.display = 'none';
  document.getElementById('contact-edit').style.display = 'block';
});
document.getElementById('btn-cancel-edit').addEventListener('click', function() {
  document.getElementById('contact-edit').style.display = 'none';
  document.getElementById('contact-display').style.display = 'block';
});
</script>
{% endblock %}
