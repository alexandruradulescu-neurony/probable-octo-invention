{% extends "base.html" %}
{% block title %}{{ object|default:"New Prompt Template" }} — RecruitFlow{% endblock %}
{% block breadcrumb %}Configure{% endblock %}
{% block page_title %}{% if object %}Edit: {{ object.name }}{% else %}New Prompt Template{% endif %}{% endblock %}

{% block topbar_actions %}
<a href="{% url 'prompts:list' %}" class="btn btn-secondary d-inline-flex align-items-center gap-2">
  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
  Back to Templates
</a>
{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- Left: Form -->
  <div class="col-lg-7">
    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.errors %}
      <div class="alert alert-danger mb-4 d-flex align-items-start gap-2">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="margin-top: 2px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        <div>
          <div class="fw-semibold">Please correct the errors below.</div>
        </div>
      </div>
      {% endif %}

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="card-header-title">Template Details</h2>
        </div>
        <div class="card-body">

          <!-- Section -->
          <div class="mb-4">
            <label for="id_section" class="form-label">Section <span class="text-danger">*</span></label>
            {{ form.section }}
            <div class="help-text">Which prompt field this template generates for the Position.</div>
            {% if form.section.errors %}<div class="error-text">{{ form.section.errors.0 }}</div>{% endif %}
          </div>

          <!-- Name -->
          <div class="mb-4">
            <label for="id_name" class="form-label">Name</label>
            {{ form.name }}
            {% if form.name.errors %}<div class="error-text">{{ form.name.errors.0 }}</div>{% endif %}
          </div>

          <!-- Meta-Prompt -->
          <div class="mb-0">
            <label for="id_meta_prompt" class="form-label">Meta-Prompt</label>
            {{ form.meta_prompt }}
            <div class="help-text" style="line-height: 1.5;">
              Available placeholders: <code class="code-inline">{title}</code>, <code class="code-inline">{description}</code>, <code class="code-inline">{campaign_questions}</code>.<br>
              Claude will respond with <strong>plain text only</strong> for the selected section — no JSON, no markdown.
            </div>
            {% if form.meta_prompt.errors %}<div class="error-text">{{ form.meta_prompt.errors.0 }}</div>{% endif %}
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100 d-flex justify-content-center align-items-center gap-2" style="padding: 0.6rem;">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
        {% if object %}Save Changes (New Version){% else %}Create Template{% endif %}
      </button>
    </form>
  </div>

  <!-- Right: Test Generate -->
  <div class="col-lg-5">
    {% if object %}
    <div class="card">
      <div class="card-header">
        <h2 class="card-header-title">Test Generate</h2>
        {% if object.section %}
        <span class="badge" style="background: var(--bg-surface-raised); color: var(--text-secondary); border: 1px solid var(--border-light); font-size: 0.7rem; font-weight: 500; padding: 0.25rem 0.5rem;">
          {{ object.get_section_display }}
        </span>
        {% else %}
        <span class="badge" style="background: rgba(234,179,8,0.15); color: #b45309; border: 1px solid #b45309; font-size: 0.7rem; padding: 0.25rem 0.5rem;">
          No section set
        </span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if not object.section %}
        <div class="alert alert-warning text-sm mb-3" style="padding: 0.75rem;">
          Set a section on this template before running a test.
        </div>
        {% endif %}

        <p class="text-sm text-tertiary mb-3" style="line-height: 1.4;">Preview Claude output for this section without saving anything.</p>

        <div class="mb-3">
          <label class="form-label">Sample Title</label>
          <input type="text" id="test-title" class="form-control" placeholder="e.g. Truck Driver CDL-A" {% if not object.section %}disabled{% endif %}>
        </div>
        <div class="mb-3">
          <label class="form-label">Sample Description</label>
          <textarea id="test-description" class="form-control" rows="2" placeholder="e.g. Regional routes, home weekends…" {% if not object.section %}disabled{% endif %}></textarea>
        </div>
        <div class="mb-4">
          <label class="form-label">Sample Questions</label>
          <textarea id="test-questions" class="form-control" rows="2" placeholder="One per line…" {% if not object.section %}disabled{% endif %}></textarea>
        </div>

        <button type="button" id="btn-test-generate" class="btn btn-secondary w-100 d-flex justify-content-center align-items-center gap-2" {% if not object.section %}disabled{% endif %}>
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
          Run Test
        </button>

        <!-- Result -->
        <div id="test-result" class="mt-4" style="display:none">
          <hr style="border-color: var(--border-light); margin: 1.5rem 0;">
          <div>
            <label class="form-label" id="result-section-label">Result</label>
            <pre id="result-value" class="text-sm text-secondary" style="white-space: pre-wrap; word-break: break-word; background: var(--bg-page); border: 1px solid var(--border-light); border-radius: var(--radius-sm); padding: 0.75rem; margin: 0; min-height: 60px;"></pre>
          </div>
        </div>

        <div id="test-error" class="alert alert-danger mt-3 text-sm" style="display:none; padding: 0.75rem;"></div>
      </div>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
{% if object and object.section %}
<script>
document.getElementById('btn-test-generate').addEventListener('click', function() {
  const btn = this;
  const title = document.getElementById('test-title').value.trim();
  if (!title) { alert('Enter a sample title.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="width: 14px; height: 14px; border-width: 1px;"></span> Running…';
  document.getElementById('test-error').style.display = 'none';
  document.getElementById('test-result').style.display = 'none';

  fetch("{% url 'prompts:test_generate' object.pk %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
    body: JSON.stringify({
      title: title,
      description: document.getElementById('test-description').value.trim(),
      campaign_questions: document.getElementById('test-questions').value.trim(),
    }),
  })
  .then(resp => resp.json().then(data => ({ ok: resp.ok, data })))
  .then(({ ok, data }) => {
    if (!ok) {
      document.getElementById('test-error').textContent = data.error || 'Unknown error';
      document.getElementById('test-error').style.display = 'block';
      return;
    }
    document.getElementById('result-section-label').textContent = 'Result — ' + (data.section || 'output').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    document.getElementById('result-value').textContent = data.value || '';
    document.getElementById('test-result').style.display = 'block';
  })
  .catch(() => {
    document.getElementById('test-error').textContent = 'Network error.';
    document.getElementById('test-error').style.display = 'block';
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="margin-right: 0.5rem;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg> Run Test';
  });
});
</script>
{% endif %}
{% endblock %}
