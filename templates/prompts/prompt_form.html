{% extends "base.html" %}
{% block title %}{{ object|default:"New Prompt Template" }} — RecruitFlow{% endblock %}
{% block breadcrumb %}Configure{% endblock %}
{% block page_title %}{% if object %}Edit Template: {{ object.name }}{% else %}New Prompt Template{% endif %}{% endblock %}

{% block topbar_actions %}
<a href="{% url 'prompts:list' %}" class="btn btn-secondary d-inline-flex align-items-center gap-2">
  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
  Back to Templates
</a>
{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- Left: Form -->
  <div class="col-lg-7">
    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.errors %}
      <div class="alert alert-danger mb-4 d-flex align-items-start gap-2">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="margin-top: 2px;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
        <div>
          <div class="fw-semibold">Please correct the errors below.</div>
        </div>
      </div>
      {% endif %}

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="card-header-title">Template Details</h2>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <label for="id_name" class="form-label">Name</label>
            {{ form.name }}
            {% if form.name.errors %}<div class="error-text">{{ form.name.errors.0 }}</div>{% endif %}
          </div>
          <div class="mb-0">
            <label for="id_meta_prompt" class="form-label">Meta-Prompt</label>
            {{ form.meta_prompt }}
            <div class="help-text" style="line-height: 1.5;">
              Available placeholders: <code style="background: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 3px; color: var(--text-secondary);">{title}</code>, <code style="background: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 3px; color: var(--text-secondary);">{description}</code>, <code style="background: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 3px; color: var(--text-secondary);">{campaign_questions}</code>.<br>
              Claude must return JSON with keys: <code style="background: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 3px; color: var(--text-secondary);">system_prompt</code>, <code style="background: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 3px; color: var(--text-secondary);">first_message</code>, <code style="background: #f0f0f0; padding: 0.1rem 0.3rem; border-radius: 3px; color: var(--text-secondary);">qualification_prompt</code>.
            </div>
            {% if form.meta_prompt.errors %}<div class="error-text">{{ form.meta_prompt.errors.0 }}</div>{% endif %}
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-primary w-100 d-flex justify-content-center align-items-center gap-2" style="padding: 0.6rem;">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
        {% if object %}Save Changes (New Version){% else %}Create Template{% endif %}
      </button>
    </form>
  </div>

  <!-- Right: Test Generate -->
  <div class="col-lg-5">
    {% if object %}
    <div class="card">
      <div class="card-header">
        <h2 class="card-header-title">Test Generate</h2>
      </div>
      <div class="card-body">
        <p class="text-sm text-tertiary mb-3" style="line-height: 1.4;">Preview Claude output using this template without saving. Reads the meta-prompt from the saved version.</p>

        <div class="mb-3">
          <label class="form-label">Sample Title</label>
          <input type="text" id="test-title" class="form-control" placeholder="e.g. Truck Driver CDL-A">
        </div>
        <div class="mb-3">
          <label class="form-label">Sample Description</label>
          <textarea id="test-description" class="form-control" rows="2" placeholder="e.g. Regional routes, home weekends…"></textarea>
        </div>
        <div class="mb-4">
          <label class="form-label">Sample Questions</label>
          <textarea id="test-questions" class="form-control" rows="2" placeholder="One per line…"></textarea>
        </div>

        <button type="button" id="btn-test-generate" class="btn btn-secondary w-100 d-flex justify-content-center align-items-center gap-2">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
          Run Test
        </button>

        <div id="test-result" class="mt-4" style="display:none">
          <hr style="border-color: var(--border-light); margin: 1.5rem 0;">
          <div class="mb-3">
            <label class="form-label">System Prompt</label>
            <pre id="result-system" class="text-sm text-secondary" style="background: #fafafa; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-light); max-height: 150px; overflow-y: auto; white-space: pre-wrap; margin: 0; font-family: monospace;"></pre>
          </div>
          <div class="mb-3">
            <label class="form-label">First Message</label>
            <pre id="result-first" class="text-sm text-secondary" style="background: #fafafa; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-light); max-height: 150px; overflow-y: auto; white-space: pre-wrap; margin: 0; font-family: monospace;"></pre>
          </div>
          <div>
            <label class="form-label">Qualification Prompt</label>
            <pre id="result-qual" class="text-sm text-secondary" style="background: #fafafa; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-light); max-height: 150px; overflow-y: auto; white-space: pre-wrap; margin: 0; font-family: monospace;"></pre>
          </div>
        </div>

        <div id="test-error" class="alert alert-danger mt-3 text-sm" style="display:none; padding: 0.75rem;"></div>
      </div>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
{% if object %}
<script>
document.getElementById('btn-test-generate').addEventListener('click', function() {
  const btn = this;
  const title = document.getElementById('test-title').value.trim();
  if (!title) { alert('Enter a sample title.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="width: 14px; height: 14px; border-width: 1px;"></span> Running…';
  document.getElementById('test-error').style.display = 'none';
  document.getElementById('test-result').style.display = 'none';

  fetch("{% url 'prompts:test_generate' object.pk %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
    body: JSON.stringify({
      title: title,
      description: document.getElementById('test-description').value.trim(),
      campaign_questions: document.getElementById('test-questions').value.trim(),
    }),
  })
  .then(resp => resp.json().then(data => ({ ok: resp.ok, data })))
  .then(({ ok, data }) => {
    if (!ok) {
      document.getElementById('test-error').textContent = data.error || 'Unknown error';
      document.getElementById('test-error').style.display = 'block';
      return;
    }
    document.getElementById('result-system').textContent = data.system_prompt || '';
    document.getElementById('result-first').textContent = data.first_message || '';
    document.getElementById('result-qual').textContent = data.qualification_prompt || '';
    document.getElementById('test-result').style.display = 'block';
  })
  .catch(err => {
    document.getElementById('test-error').textContent = 'Network error.';
    document.getElementById('test-error').style.display = 'block';
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="margin-right: 0.5rem;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg> Run Test';
  });
});
</script>
{% endif %}
{% endblock %}
