{% extends "base.html" %}
{% block title %}{{ object|default:"New Prompt Template" }} — RecruitFlow{% endblock %}
{% block page_title %}{% if object %}Edit Template: {{ object.name }}{% else %}New Prompt Template{% endif %}{% endblock %}

{% block topbar_actions %}
<a href="{% url 'prompts:list' %}" class="btn btn-sm btn-outline-secondary">
  <i class="bi bi-arrow-left"></i> Back to Templates
</a>
{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- Left: Form -->
  <div class="col-lg-7">
    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.errors %}
      <div class="alert alert-danger">
        <strong>Please correct the errors below.</strong>
      </div>
      {% endif %}

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white fw-semibold">Template Details</div>
        <div class="card-body">
          <div class="mb-3">
            <label for="id_name" class="form-label">Name</label>
            {{ form.name }}
            {% if form.name.errors %}<div class="text-danger small mt-1">{{ form.name.errors.0 }}</div>{% endif %}
          </div>
          <div class="mb-0">
            <label for="id_meta_prompt" class="form-label">Meta-Prompt</label>
            {{ form.meta_prompt }}
            <div class="form-text">
              Available placeholders: <code>{title}</code>, <code>{description}</code>, <code>{campaign_questions}</code>.
              Claude must return JSON with keys: <code>system_prompt</code>, <code>first_message</code>, <code>qualification_prompt</code>.
            </div>
            {% if form.meta_prompt.errors %}<div class="text-danger small mt-1">{{ form.meta_prompt.errors.0 }}</div>{% endif %}
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-dark w-100">
        <i class="bi bi-check-lg"></i>
        {% if object %}Save Changes (New Version){% else %}Create Template{% endif %}
      </button>
    </form>
  </div>

  <!-- Right: Test Generate -->
  <div class="col-lg-5">
    {% if object %}
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white fw-semibold">
        <i class="bi bi-play-circle"></i> Test Generate
      </div>
      <div class="card-body">
        <p class="small text-muted mb-3">Preview Claude output using this template without saving. Reads the meta-prompt from the saved version.</p>

        <div class="mb-2">
          <label class="form-label small mb-1">Sample Title</label>
          <input type="text" id="test-title" class="form-control form-control-sm" placeholder="e.g. Truck Driver CDL-A">
        </div>
        <div class="mb-2">
          <label class="form-label small mb-1">Sample Description</label>
          <textarea id="test-description" class="form-control form-control-sm" rows="2" placeholder="e.g. Regional routes, home weekends…"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label small mb-1">Sample Questions</label>
          <textarea id="test-questions" class="form-control form-control-sm" rows="2" placeholder="One per line…"></textarea>
        </div>

        <button type="button" id="btn-test-generate" class="btn btn-sm btn-outline-primary w-100">
          <i class="bi bi-stars"></i> Run Test
        </button>

        <div id="test-result" class="mt-3" style="display:none">
          <hr>
          <div class="mb-2">
            <label class="form-label small fw-semibold mb-1">System Prompt</label>
            <pre id="result-system" class="bg-light p-2 rounded small" style="max-height:150px;overflow-y:auto;white-space:pre-wrap"></pre>
          </div>
          <div class="mb-2">
            <label class="form-label small fw-semibold mb-1">First Message</label>
            <pre id="result-first" class="bg-light p-2 rounded small" style="max-height:150px;overflow-y:auto;white-space:pre-wrap"></pre>
          </div>
          <div>
            <label class="form-label small fw-semibold mb-1">Qualification Prompt</label>
            <pre id="result-qual" class="bg-light p-2 rounded small" style="max-height:150px;overflow-y:auto;white-space:pre-wrap"></pre>
          </div>
        </div>

        <div id="test-error" class="alert alert-danger mt-3 small" style="display:none"></div>
      </div>
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
{% if object %}
<script>
document.getElementById('btn-test-generate').addEventListener('click', function() {
  const btn = this;
  const title = document.getElementById('test-title').value.trim();
  if (!title) { alert('Enter a sample title.'); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Running…';
  document.getElementById('test-error').style.display = 'none';
  document.getElementById('test-result').style.display = 'none';

  fetch("{% url 'prompts:test_generate' object.pk %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}',
    },
    body: JSON.stringify({
      title: title,
      description: document.getElementById('test-description').value.trim(),
      campaign_questions: document.getElementById('test-questions').value.trim(),
    }),
  })
  .then(resp => resp.json().then(data => ({ ok: resp.ok, data })))
  .then(({ ok, data }) => {
    if (!ok) {
      document.getElementById('test-error').textContent = data.error || 'Unknown error';
      document.getElementById('test-error').style.display = 'block';
      return;
    }
    document.getElementById('result-system').textContent = data.system_prompt || '';
    document.getElementById('result-first').textContent = data.first_message || '';
    document.getElementById('result-qual').textContent = data.qualification_prompt || '';
    document.getElementById('test-result').style.display = 'block';
  })
  .catch(err => {
    document.getElementById('test-error').textContent = 'Network error.';
    document.getElementById('test-error').style.display = 'block';
  })
  .finally(() => {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-stars"></i> Run Test';
  });
});
</script>
{% endif %}
{% endblock %}
