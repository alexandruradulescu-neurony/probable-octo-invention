{% extends "base.html" %}
{% block title %}Dashboard — RecruitFlow{% endblock %}
{% block breadcrumb %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block topbar_actions %}
<a href="{% url 'candidates:csv_import' %}" class="btn btn-secondary d-inline-flex align-items-center gap-2">
  <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
  Upload CSV
</a>
<a href="{% url 'positions:create' %}" class="btn btn-primary d-inline-flex align-items-center gap-2 ms-2">
  <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
  New Position
</a>
{% endblock %}

{% block content %}
<style>
  /* ── Pipeline ── */
  .pipeline-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.65rem;
  }
  .pipeline-row:last-child { margin-bottom: 0; }
  .pipeline-label {
    width: 88px;
    font-size: 0.75rem;
    color: var(--text-tertiary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }
  .pipeline-track {
    flex: 1;
    height: 6px;
    background: var(--border-default);
    border-radius: 99px;
    overflow: hidden;
  }
  .pipeline-bar {
    height: 100%;
    border-radius: 99px;
    transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .pipeline-count {
    width: 30px;
    text-align: right;
    font-size: 0.85rem;
    color: var(--text-primary);
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    flex-shrink: 0;
  }
</style>

<!-- KPI Stat Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-6 col-xl-3">
    <div class="card kpi-card h-100">
      <div class="card-body">
        <div class="kpi-top">
          <span class="kpi-label">Calls Today</span>
          <div class="kpi-icon kpi-icon-purple">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.42 2 2 0 0 1 3.6 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.6A16 16 0 0 0 14 14.69l.94-.94a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
          </div>
        </div>
        <div class="kpi-value">{{ activity_feed.calls_today|default:"0" }}</div>
        <div class="kpi-sub">Since midnight</div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-xl-3">
    <div class="card kpi-card h-100">
      <div class="card-body">
        <div class="kpi-top">
          <span class="kpi-label">CVs Received</span>
          <div class="kpi-icon kpi-icon-teal">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>
          </div>
        </div>
        <div class="kpi-value">{{ activity_feed.cvs_today|default:"0" }}</div>
        <div class="kpi-sub">Since midnight</div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-xl-3">
    <div class="card kpi-card h-100">
      <div class="card-body">
        <div class="kpi-top">
          <span class="kpi-label">Follow-ups Sent</span>
          <div class="kpi-icon kpi-icon-blue">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </div>
        </div>
        <div class="kpi-value">{{ activity_feed.followups_today|default:"0" }}</div>
        <div class="kpi-sub">Since midnight</div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-xl-3">
    <div class="card kpi-card h-100">
      <div class="card-body">
        <div class="kpi-top">
          <span class="kpi-label">Open Positions</span>
          <div class="kpi-icon kpi-icon-orange">
            <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
          </div>
        </div>
        <div class="kpi-value">{{ position_summaries|length|default:"0" }}</div>
        <div class="kpi-sub">Currently active</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <!-- Left Column: Positions table + Attention items -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h2 class="card-header-title">Active Positions</h2>
        <a href="{% url 'positions:list' %}" class="view-all-link">View all &rarr;</a>
      </div>

      {% if position_summaries %}
      <div class="table-responsive">
        <table class="table mb-0">
          <thead>
            <tr>
              <th>Position</th>
              <th>Pending Calls</th>
              <th>In Progress</th>
              <th>Awaiting CV</th>
              <th>Completed</th>
            </tr>
          </thead>
          <tbody>
            {% for s in position_summaries %}
            <tr>
              <td>
                <a href="{% url 'applications:list' %}?position={{ s.position.pk }}" class="fw-medium text-decoration-none hover-underline">{{ s.position.title }}</a>
                <div class="text-xs text-muted-custom mt-1">{{ s.total }} total</div>
              </td>
              <td>
                {% if s.pending_calls %}
                  <div class="badge status-screening"><span class="badge-dot"></span> {{ s.pending_calls }}</div>
                {% else %}
                  <span class="text-muted-custom">—</span>
                {% endif %}
              </td>
              <td>
                {% if s.in_progress %}
                  <div class="badge status-interview"><span class="badge-dot"></span> {{ s.in_progress }}</div>
                {% else %}
                  <span class="text-muted-custom">—</span>
                {% endif %}
              </td>
              <td>
                {% if s.awaiting_cv %}
                  <div class="badge status-review"><span class="badge-dot"></span> {{ s.awaiting_cv }}</div>
                {% else %}
                  <span class="text-muted-custom">—</span>
                {% endif %}
              </td>
              <td>
                {% if s.completed %}
                  <div class="badge status-offered"><span class="badge-dot"></span> {{ s.completed }}</div>
                {% else %}
                  <span class="text-muted-custom">—</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="card-body text-center py-5">
        <div class="empty-state-icon mx-auto mb-3">
          <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
        </div>
        <div class="empty-state-title">No open positions</div>
        <div class="empty-state-desc">Create a position to start tracking candidates.</div>
        <a href="{% url 'positions:create' %}" class="btn btn-secondary btn-sm">Create Position</a>
      </div>
      {% endif %}
    </div>

    <!-- Needs Attention -->
    {% with a=attention_required %}
    {% if a.call_failures or a.cv_overdue or a.needs_human or a.callbacks_today or a.unmatched_inbound or a.needs_review_cvs %}
    <div class="mt-4">
      <div class="d-flex align-items-center gap-2 mb-3">
        <div style="width:6px;height:6px;border-radius:50%;background:var(--accent-negative);flex-shrink:0;"></div>
        <span style="font-size:0.70rem;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.10em;">Needs Attention</span>
      </div>
      <div class="row g-2">
        {% if a.call_failures %}
        <div class="col-sm-6">
          <a href="{% url 'applications:list' %}?status=call_failed" class="text-decoration-none">
            <div class="attn-item attn-item-danger">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
              <span class="attn-item-label">Call Failures</span>
              <span class="attn-item-count attn-count-danger">{{ a.call_failures }}</span>
            </div>
          </a>
        </div>
        {% endif %}
        {% if a.cv_overdue %}
        <div class="col-sm-6">
          <a href="{% url 'applications:list' %}?status=cv_overdue" class="text-decoration-none">
            <div class="attn-item attn-item-warning">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              <span class="attn-item-label">CV Overdue</span>
              <span class="attn-item-count attn-count-warning">{{ a.cv_overdue }}</span>
            </div>
          </a>
        </div>
        {% endif %}
        {% if a.callbacks_today %}
        <div class="col-sm-6">
          <a href="{% url 'applications:list' %}?status=callback_scheduled" class="text-decoration-none">
            <div class="attn-item attn-item-info">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
              <span class="attn-item-label">Callbacks Today</span>
              <span class="attn-item-count attn-count-info">{{ a.callbacks_today }}</span>
            </div>
          </a>
        </div>
        {% endif %}
        {% if a.needs_review_cvs %}
        <div class="col-sm-6">
          <a href="{% url 'cvs:inbox' %}" class="text-decoration-none">
            <div class="attn-item attn-item-warning">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              <span class="attn-item-label">CVs Need Review</span>
              <span class="attn-item-count attn-count-warning">{{ a.needs_review_cvs }}</span>
            </div>
          </a>
        </div>
        {% endif %}
        {% if a.needs_human %}
        <div class="col-sm-6">
          <a href="{% url 'applications:list' %}?needs_human=1" class="text-decoration-none">
            <div class="attn-item attn-item-info">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
              <span class="attn-item-label">Needs Human Review</span>
              <span class="attn-item-count attn-count-info">{{ a.needs_human }}</span>
            </div>
          </a>
        </div>
        {% endif %}
        {% if a.unmatched_inbound %}
        <div class="col-sm-6">
          <a href="{% url 'cvs:inbox' %}" class="text-decoration-none">
            <div class="attn-item attn-item-warning">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="flex-shrink:0;"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>
              <span class="attn-item-label">Unmatched Inbound</span>
              <span class="attn-item-count attn-count-warning">{{ a.unmatched_inbound }}</span>
            </div>
          </a>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% endwith %}
  </div>

  <!-- Right Column: Pipeline & Activity -->
  <div class="col-lg-4">
    <!-- Pipeline Widget -->
    <div class="card mb-3">
      <div class="card-header">
        <h2 class="card-header-title">Pipeline</h2>
      </div>
      <div class="card-body" style="padding: 1.25rem;">
        {% for stage in pipeline_data %}
        <div class="pipeline-row">
          <div class="pipeline-label">{{ stage.label }}</div>
          <div class="pipeline-track"><div class="pipeline-bar" style="width: {{ stage.pct }}%; background: {{ stage.color }};"></div></div>
          <div class="pipeline-count">{{ stage.count }}</div>
        </div>
        {% empty %}
        <div class="text-sm text-tertiary text-center py-3">No applications yet.</div>
        {% endfor %}
      </div>
    </div>

    <!-- Recent Activity Feed -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-header-title">Recent Activity</h2>
        <a href="{% url 'applications:list' %}" class="view-all-link">View all &rarr;</a>
      </div>
      {% if recent_changes %}
      <div class="activity-list py-2">
        {% for sc in recent_changes %}
        <a href="{% url 'applications:detail' sc.application.pk %}" class="text-decoration-none">
          <div class="activity-row">
            <div class="activity-dot-col">
              <div class="activity-dot"></div>
              {% if not forloop.last %}<div class="activity-connector"></div>{% endif %}
            </div>
            <div class="activity-body">
              <div class="activity-who">
                <strong>{{ sc.application.candidate.full_name }}</strong>
                &rarr; {{ sc.get_to_status_display }}
              </div>
              <div class="activity-sub">{{ sc.application.position.title }} &middot; {{ sc.changed_at|date:"d M H:i" }}</div>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="card-body text-center py-4">
        <div class="text-sm text-tertiary">No recent activity.</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
