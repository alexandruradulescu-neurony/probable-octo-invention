{% extends "base.html" %}
{% block title %}Edit Message Template — RecruitFlow{% endblock %}
{% block breadcrumb %}<span class="bc-section">Configure</span><span class="bc-sep">/</span><span class="bc-section">Templates</span><span class="bc-sep">/</span><span class="bc-page">Edit: {{ object }}</span>{% endblock %}

{% block topbar_actions %}
<a href="{% url 'messaging:template_list' %}"
   class="btn btn-secondary d-inline-flex align-items-center gap-2">
  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
    <line x1="19" y1="12" x2="5" y2="12"></line>
    <polyline points="12 19 5 12 12 5"></polyline>
  </svg>
  Back to Templates
</a>
{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- Left: Form -->
  <div class="col-lg-7">
    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.errors %}
      <div class="alert alert-danger mb-4 d-flex align-items-start gap-2">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"
             style="margin-top:2px;">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <div><div class="fw-semibold">Please correct the errors below.</div></div>
      </div>
      {% endif %}

      <div class="card mb-4">
        <div class="card-header">
          <h2 class="card-header-title">Template Details</h2>
        </div>
        <div class="card-body">

          <!-- Read-only type + channel banner -->
          <div class="mb-4 p-3 rounded d-flex align-items-center gap-3"
               style="background:var(--bg-subtle);border:1px solid var(--border-light);">
            <div>
              {% if object.channel == "whatsapp" %}
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"
                   style="color:var(--accent-positive);">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
              </svg>
              {% else %}
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"
                   style="color:var(--text-secondary);">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              {% endif %}
            </div>
            <div>
              <div class="fw-semibold text-sm">{{ object.get_message_type_display }}</div>
              <div class="text-xs text-muted-custom">{{ object.get_channel_display }}</div>
            </div>
          </div>

          {% if object.channel == "email" %}
          <div class="mb-4">
            <label for="id_subject" class="form-label">{{ form.subject.label }}</label>
            {{ form.subject }}
            <div class="help-text">Supports <code class="code-inline">{position_title}</code></div>
            {% if form.subject.errors %}
            <div class="error-text">{{ form.subject.errors.0 }}</div>
            {% endif %}
          </div>
          {% endif %}

          <div class="mb-4">
            <label for="id_body" class="form-label">{{ form.body.label }}</label>
            {{ form.body }}
            {% if form.body.errors %}
            <div class="error-text">{{ form.body.errors.0 }}</div>
            {% endif %}
          </div>

          <div class="form-check">
            {{ form.is_active }}
            <label class="form-check-label text-sm" for="id_is_active">
              {{ form.is_active.label }}
            </label>
          </div>

        </div>
      </div>

      <button type="submit"
              class="btn btn-primary w-100 d-flex justify-content-center align-items-center gap-2"
              style="padding:0.6rem;">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Save Template
      </button>
    </form>
  </div>

  <!-- Right: Placeholder reference -->
  <div class="col-lg-5">
    <div class="card">
      <div class="card-header">
        <h2 class="card-header-title">Available Placeholders</h2>
      </div>
      <div class="card-body">
        <p class="text-sm text-tertiary mb-3" style="line-height:1.5;">
          Insert these tokens anywhere in the subject or body — they are replaced
          automatically when the message is sent.
        </p>
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th class="text-xs">Token</th>
              <th class="text-xs">Replaced with</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code class="code-inline">{first_name}</code></td>
              <td class="text-xs text-secondary">Candidate's first name</td>
            </tr>
            <tr>
              <td><code class="code-inline">{position_title}</code></td>
              <td class="text-xs text-secondary">Job / position title</td>
            </tr>
            <tr>
              <td><code class="code-inline">{application_pk}</code></td>
              <td class="text-xs text-secondary">Application reference number</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Preview card -->
    <div class="card mt-4">
      <div class="card-header">
        <h2 class="card-header-title">Live Preview</h2>
      </div>
      <div class="card-body">
        <p class="text-xs text-muted-custom mb-3">
          Values below are sample data used only for preview.
        </p>
        <div class="mb-2 d-flex gap-2">
          <input type="text" id="prev-name" class="form-control form-control-sm"
                 placeholder="First name" value="Ana">
          <input type="text" id="prev-position" class="form-control form-control-sm"
                 placeholder="Position title" value="Sales Manager">
          <input type="text" id="prev-pk" class="form-control form-control-sm"
                 placeholder="App #" value="42" style="max-width:80px;">
        </div>
        {% if object.channel == "email" %}
        <div class="mb-2">
          <div class="text-xs text-muted-custom mb-1">Subject</div>
          <div id="prev-subject"
               class="text-sm p-2 rounded"
               style="background:var(--bg-subtle);border:1px solid var(--border-light);min-height:28px;font-style:italic;"></div>
        </div>
        {% endif %}
        <div class="text-xs text-muted-custom mb-1">Body</div>
        <pre id="prev-body"
             class="text-sm p-2 rounded mb-0"
             style="background:var(--bg-subtle);border:1px solid var(--border-light);
                    white-space:pre-wrap;word-break:break-word;min-height:80px;font-style:italic;"></pre>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  var bodyEl    = document.getElementById('id_body');
  var subjEl    = document.getElementById('id_subject');
  var prevBody  = document.getElementById('prev-body');
  var prevSubj  = document.getElementById('prev-subject');
  var prevName  = document.getElementById('prev-name');
  var prevPos   = document.getElementById('prev-position');
  var prevPk    = document.getElementById('prev-pk');

  function interpolate(text) {
    return text
      .replace(/\{first_name\}/g, prevName.value || 'Ana')
      .replace(/\{position_title\}/g, prevPos.value || 'Sales Manager')
      .replace(/\{application_pk\}/g, prevPk.value || '42');
  }

  function update() {
    if (prevBody && bodyEl) prevBody.textContent = interpolate(bodyEl.value);
    if (prevSubj && subjEl) prevSubj.textContent = interpolate(subjEl.value);
  }

  if (bodyEl) bodyEl.addEventListener('input', update);
  if (subjEl) subjEl.addEventListener('input', update);
  [prevName, prevPos, prevPk].forEach(function(el) {
    if (el) el.addEventListener('input', update);
  });

  update();
})();
</script>
{% endblock %}
