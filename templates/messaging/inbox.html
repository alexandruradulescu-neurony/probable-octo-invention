{% extends "base.html" %}
{% block title %}Messages — RecruitFlow{% endblock %}
{% block breadcrumb %}Messages{% endblock %}
{% block page_title %}Candidate Messages{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between">
    <h2 class="card-header-title">Conversations</h2>
    {% if unread_count %}
    <span class="badge status-screening"><span class="badge-dot"></span> {{ unread_count }} unread</span>
    {% endif %}
  </div>

  {% if conversations %}
  <div class="table-responsive">
    <table class="table mb-0" id="conv-table">
      <thead>
        <tr>
          <th style="width:8px;"></th>
          <th>From</th>
          <th>Channel</th>
          <th>Last Message</th>
          <th>Application</th>
          <th class="text-center">Messages</th>
          <th>Last Received</th>
          <th class="no-row-click"></th>
        </tr>
      </thead>
      <tbody>

        {% for conv in conversations %}
        {% with conv_id="conv-"|add:forloop.counter|stringformat:"s" %}

        {# ── Conversation summary row ── #}
        <tr class="conv-row {% if conv.unread %}conv-unread{% endif %}"
            data-conv="{{ conv_id }}"
            style="cursor:pointer;{% if conv.unread %}background:var(--bg-subtle);{% endif %}">

          {# Unread dot #}
          <td class="ps-3" style="width:16px;">
            {% if conv.unread %}
            <span class="unread-dot"
                  style="display:inline-block;width:8px;height:8px;border-radius:50%;
                         background:var(--accent-primary);flex-shrink:0;"></span>
            {% endif %}
          </td>

          {# Sender #}
          <td>
            {% if conv.candidate %}
            <div class="fw-medium text-sm">{{ conv.candidate.full_name }}</div>
            <div class="text-xs text-muted-custom">{{ conv.sender }}</div>
            {% else %}
            <div class="text-sm fw-medium">{{ conv.sender }}</div>
            <div class="text-xs text-muted-custom">Unknown</div>
            {% endif %}
          </td>

          {# Channel badges #}
          <td>
            <div class="d-flex flex-column gap-1">
              {% if "whatsapp" in conv.channels %}
              <div class="d-flex align-items-center gap-1 text-xs" style="color:var(--accent-positive);">
                <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                </svg>
                WhatsApp
              </div>
              {% endif %}
              {% if "email" in conv.channels %}
              <div class="d-flex align-items-center gap-1 text-xs text-secondary">
                <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                  <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                Email
              </div>
              {% endif %}
            </div>
          </td>

          {# Last message preview #}
          <td style="max-width:320px;">
            {% if conv.last_message.subject %}
            <div class="text-sm fw-medium text-truncate">{{ conv.last_message.subject }}</div>
            {% endif %}
            <div class="text-xs text-muted-custom text-truncate">{{ conv.last_message.body|truncatechars:100 }}</div>
          </td>

          {# Linked application #}
          <td class="text-sm">
            {% if conv.application %}
            <a href="{% url 'applications:detail' conv.application.pk %}"
               class="text-decoration-none no-row-click"
               onclick="event.stopPropagation();">
              {% if conv.candidate %}{{ conv.candidate.full_name }}{% else %}App #{{ conv.application.pk }}{% endif %}
              <span class="text-muted-custom text-xs">· {{ conv.application.position.title|truncatechars:22 }}</span>
            </a>
            {% else %}
            <span class="text-muted-custom text-xs">Unmatched</span>
            {% endif %}
          </td>

          {# Message count #}
          <td class="text-center tabular-nums">
            <span class="text-sm">{{ conv.total }}</span>
            {% if conv.unread %}
            <span class="text-xs ms-1" style="color:var(--accent-primary);">({{ conv.unread }} new)</span>
            {% endif %}
          </td>

          {# Timestamp #}
          <td class="text-xs text-muted-custom tabular-nums text-nowrap">
            {{ conv.last_received|date:"M j, Y H:i" }}
          </td>

          {# Actions #}
          <td class="no-row-click text-end" style="white-space:nowrap;">
            <div class="d-flex align-items-center justify-content-end gap-1">
              {% if conv.unread %}
              <form method="post" action="{% url 'messaging:conversation_mark_read' %}" class="m-0">
                {% csrf_token %}
                <input type="hidden" name="sender" value="{{ conv.sender }}">
                <button type="submit"
                        class="btn btn-sm"
                        style="font-size:11px;padding:2px 8px;border:1px solid var(--border-light);
                               border-radius:var(--radius-sm);background:none;color:var(--text-muted);"
                        title="Mark all as read">
                  Mark read
                </button>
              </form>
              {% endif %}
              <button type="button"
                      class="btn btn-sm conv-toggle"
                      data-target="{{ conv_id }}"
                      style="font-size:11px;padding:2px 8px;border:1px solid var(--border-light);
                             border-radius:var(--radius-sm);background:none;color:var(--text-muted);"
                      title="Expand conversation">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.2"
                     stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"
                     class="chevron-icon">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <form method="post" action="{% url 'messaging:conversation_delete' %}" class="m-0"
                    onsubmit="return confirm('Delete all messages from {{ conv.sender|escapejs }}? This cannot be undone.');">
                {% csrf_token %}
                <input type="hidden" name="sender" value="{{ conv.sender }}">
                <button type="submit"
                        class="btn btn-sm delete-btn"
                        style="font-size:11px;padding:2px 6px;border:1px solid var(--border-light);
                               border-radius:var(--radius-sm);background:none;color:var(--text-muted);
                               transition:border-color .15s,color .15s;"
                        onmouseover="this.style.borderColor='var(--accent-danger)';this.style.color='var(--accent-danger)';"
                        onmouseout="this.style.borderColor='var(--border-light)';this.style.color='var(--text-muted)';"
                        title="Delete conversation">
                  <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.2"
                       stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                    <path d="M10 11v6"></path><path d="M14 11v6"></path>
                    <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                  </svg>
                </button>
              </form>
            </div>
          </td>
        </tr>

        {# ── Expanded messages ── #}
        <tr class="conv-detail" id="{{ conv_id }}" style="display:none;">
          <td colspan="8" class="p-0">
            <div style="background:var(--bg-page);border-top:1px solid var(--border-light);
                        border-bottom:1px solid var(--border-light);">
              <table class="table table-sm mb-0" style="font-size:13px;">
                <thead style="background:var(--bg-subtle);">
                  <tr>
                    <th class="ps-4" style="width:140px;">Time</th>
                    <th style="width:80px;">Channel</th>
                    <th>Message</th>
                    <th class="text-center" style="width:70px;">Read</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody>
                  {% for msg in conv.messages %}
                  <tr style="{% if not msg.is_read %}background:var(--bg-subtle);{% endif %}">
                    <td class="ps-4 text-xs text-muted-custom tabular-nums text-nowrap">
                      {{ msg.received_at|date:"M j, Y H:i" }}
                    </td>
                    <td>
                      {% if msg.channel == "whatsapp" %}
                      <span class="text-xs" style="color:var(--accent-positive);">WhatsApp</span>
                      {% else %}
                      <span class="text-xs text-secondary">Email</span>
                      {% endif %}
                    </td>
                    <td style="max-width:500px;">
                      {% if msg.subject %}
                      <div class="fw-medium text-xs mb-1">{{ msg.subject }}</div>
                      {% endif %}
                      <div class="text-xs text-secondary" style="white-space:pre-wrap;word-break:break-word;">{{ msg.body|truncatechars:300 }}</div>
                    </td>
                    <td class="text-center">
                      {% if msg.is_read %}
                      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"
                           stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"
                           style="color:var(--accent-positive);">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      {% else %}
                      <span class="unread-dot"
                            style="display:inline-block;width:7px;height:7px;border-radius:50%;
                                   background:var(--accent-primary);"></span>
                      {% endif %}
                    </td>
                    <td class="no-row-click">
                      {% if not msg.is_read %}
                      <form method="post" action="{% url 'messaging:reply_read' msg.pk %}" class="m-0">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'messaging:inbox' %}">
                        <button type="submit"
                                class="btn btn-sm"
                                style="font-size:10px;padding:1px 6px;border:1px solid var(--border-light);
                                       border-radius:var(--radius-sm);background:none;color:var(--text-muted);">
                          Mark read
                        </button>
                      </form>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </td>
        </tr>

        {% endwith %}
        {% endfor %}

      </tbody>
    </table>
  </div>

  {% else %}
  <div class="card-body text-center py-5">
    <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5"
         stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"
         style="color:var(--text-muted);margin-bottom:12px;">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <div class="text-sm text-tertiary">No candidate messages yet.</div>
    <div class="text-xs text-muted-custom mt-1">
      WhatsApp and email replies from candidates will appear here.
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  // ── Expand / collapse conversation rows ─────────────────────────────────
  function toggleConv(convId) {
    var detail  = document.getElementById(convId);
    var row     = document.querySelector('[data-conv="' + convId + '"]');
    var chevron = row ? row.querySelector('.chevron-icon') : null;
    if (!detail) return;

    var isOpen = detail.style.display !== 'none';
    detail.style.display = isOpen ? 'none' : 'table-row';
    if (chevron) {
      chevron.style.transform = isOpen ? '' : 'rotate(180deg)';
    }
  }

  // Clicking the summary row (not action cells) toggles expansion
  document.querySelectorAll('.conv-row').forEach(function (row) {
    row.addEventListener('click', function (e) {
      if (e.target.closest('.no-row-click, form, button, a, input')) return;
      toggleConv(row.dataset.conv);
    });
  });

  // Chevron button also toggles
  document.querySelectorAll('.conv-toggle').forEach(function (btn) {
    btn.addEventListener('click', function (e) {
      e.stopPropagation();
      toggleConv(btn.dataset.target);
    });
  });
})();
</script>
{% endblock %}
